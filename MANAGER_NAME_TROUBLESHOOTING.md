# Диагностика проблемы с полем "ФИО Менеджера"

## Проблема
Поле "ФИО Менеджера" распознается корректно у одного пользователя, но не распознается у другого.

## Возможные причины

### 1. Разная структура Excel файлов
**Симптомы:**
- У вас файл распознается, у коллеги - нет
- Используются разные шаблоны заявок

**Решение:**
- Убедитесь, что оба используют одинаковый шаблон Excel
- Проверьте, что ячейка C5 содержит ФИО менеджера в обоих файлах
- Используйте тестовый скрипт для проверки:
  ```bash
  python test_manager_name.py /path/to/file.xlsx
  ```

### 2. Неправильный выбор типа заявки
**Симптомы:**
- Поле не распознается при выборе определенного типа заявки

**Решение:**
- При загрузке файла выбирайте правильный тип:
  - "Заявка от юр.лица" - для стандартных заявок
  - "Заявка от ИП" - для заявок от индивидуальных предпринимателей
- Ячейка C5 находится на строке ≤8, поэтому смещение для ИП не применяется
- Оба типа должны корректно читать C5

### 3. Пустая ячейка C5 в файле
**Симптомы:**
- Поле отображается как "Не указано"
- В логах: `Manager name extracted from C5: '' (empty: True)`

**Решение:**
- Откройте Excel файл и проверьте ячейку C5
- Убедитесь, что ячейка содержит текст (не формулу)
- Проверьте, что ячейка не объединена с другими

### 4. Формат файла (.xls vs .xlsx)
**Симптомы:**
- Старые файлы .xls могут читаться по-другому

**Решение:**
- Пересохраните файл в формат .xlsx
- Используйте "Сохранить как" → "Excel Workbook (.xlsx)"

### 5. Скрытые символы или форматирование
**Симптомы:**
- Ячейка выглядит заполненной, но система не видит значение

**Решение:**
- Скопируйте содержимое ячейки C5 в Блокнот и обратно
- Удалите лишние пробелы и невидимые символы
- Убедитесь, что это текст, а не формула

## Диагностика через логи

### Включение детального логирования
Система автоматически логирует извлечение ФИО Менеджера. Проверьте логи:

```bash
# Для локальной разработки
tail -f logs/debug.log | grep "manager_name"

# Для продакшена
tail -f /path/to/production/logs/app.log | grep "manager_name"
```

### Что искать в логах:

1. **При извлечении из Excel:**
   ```
   Manager name extracted from C5 (openpyxl): 'Иванов Иван Иванович' (empty: False)
   ```
   или
   ```
   Manager name extracted from C5 (pandas): 'Иванов Иван Иванович' (empty: False)
   ```

2. **При создании заявки:**
   ```
   Creating request with manager_name: 'Иванов Иван Иванович' (empty: False)
   ```

3. **В итоговом логе:**
   ```
   Successfully extracted data with openpyxl: ... manager_name='Иванов Иван Иванович' ...
   ```

### Признаки проблемы в логах:
- `manager_name='' (empty: True)` - ячейка пустая
- Отсутствие логов о manager_name - ошибка при чтении файла

## Тестирование

### Шаг 1: Проверка файла
```bash
python test_manager_name.py /path/to/application.xlsx
```

Скрипт покажет:
- Содержимое ячейки C5
- Тип данных
- Соседние ячейки для контекста
- Результаты чтения через openpyxl и pandas

### Шаг 2: Проверка в системе
1. Загрузите файл через веб-интерфейс
2. Выберите правильный тип заявки
3. После создания заявки откройте её
4. Проверьте блок "Дополнительная информация о заявке"
5. Найдите поле "ФИО Менеджера"

### Шаг 3: Сравнение файлов
Если у одного пользователя работает, а у другого нет:
1. Попросите обоих отправить свои Excel файлы
2. Запустите тестовый скрипт для обоих файлов
3. Сравните результаты
4. Проверьте различия в структуре файлов

## Быстрое решение

### Для пользователя:
1. Откройте Excel файл
2. Убедитесь, что в ячейке C5 есть ФИО менеджера
3. Если ячейка пустая - заполните её
4. Сохраните файл как .xlsx
5. Загрузите файл заново

### Для администратора:
1. Проверьте логи при загрузке файла
2. Используйте тестовый скрипт для диагностики
3. Сравните файлы разных пользователей
4. Убедитесь, что используется одинаковый шаблон

## Контрольный список

- [ ] Ячейка C5 содержит текст (не пустая)
- [ ] Файл в формате .xlsx
- [ ] Выбран правильный тип заявки при загрузке
- [ ] Выбран правильный формат заявки (КАСКО/имущество)
- [ ] Нет объединенных ячеек в области C5
- [ ] Нет скрытых символов в ячейке
- [ ] Используется актуальный шаблон заявки
- [ ] Логи показывают корректное извлечение данных

## Дополнительная информация

### Техническая справка:
- **Ячейка:** C5 (столбец C, строка 5)
- **Смещение для ИП:** Не применяется (строка ≤8)
- **Методы чтения:** openpyxl (для .xlsx) и pandas (для .xls)
- **Поле в БД:** `manager_name` (VARCHAR 255, nullable)
- **Отображение:** Блок "Дополнительная информация о заявке"

### Связанные файлы:
- `core/excel_utils.py` - логика извлечения
- `insurance_requests/models.py` - модель данных
- `insurance_requests/views.py` - создание заявки
- `insurance_requests/templates/insurance_requests/request_detail.html` - отображение

## Поддержка

Если проблема не решается:
1. Соберите логи при загрузке файла
2. Запустите тестовый скрипт и сохраните вывод
3. Приложите проблемный Excel файл
4. Укажите тип и формат заявки, которые выбирались
5. Обратитесь к разработчику с этой информацией
