# Руководство по настройке SSL для Timeweb

## Проблема с текущим SSL

Текущие SSL скрипты не работают, потому что:

1. **Неправильный подход**: Скрипты пытаются установить certbot на хосте и использовать standalone режим
2. **Docker окружение**: Нужно использовать Docker контейнеры для получения сертификатов
3. **Webroot метод**: Нужно использовать webroot метод через nginx, а не standalone

## Новое решение

### 1. Docker-based подход
- Используем официальный `certbot/certbot` Docker образ
- Webroot метод через nginx
- Bind mounts вместо Docker volumes для легкого доступа к сертификатам

### 2. Пошаговый процесс
1. Запускаем nginx с HTTP-only конфигурацией
2. Создаем webroot директорию для ACME challenge
3. Запускаем certbot в Docker контейнере
4. Проверяем полученные сертификаты
5. Переключаемся на HTTPS конфигурацию
6. Перезапускаем с SSL профилем

### 3. Файлы которые были созданы/изменены

#### Новые файлы:
- `scripts/ssl/obtain-certificates-docker.sh` - Docker-based скрипт получения сертификатов
- `nginx-timeweb/default-acme.conf` - Конфигурация nginx для ACME challenge

#### Измененные файлы:
- `docker-compose.timeweb.yml` - bind mounts вместо volumes
- `.github/workflows/deploy_timeweb.yml` - использование нового скрипта

## Требования для работы SSL

### 1. DNS настройки
Домены должны указывать на IP сервера:
```
insflow.ru -> 80.90.189.37
zs.insflow.ru -> 80.90.189.37
insflow.tw1.su -> 80.90.189.37
zs.insflow.tw1.su -> 80.90.189.37
```

### 2. Порты
- Порт 80 должен быть открыт для ACME challenge
- Порт 443 должен быть открыт для HTTPS

### 3. Доступность доменов
Домены должны быть доступны по HTTP до получения сертификатов

## Тестирование SSL

### Ручное тестирование (на сервере):
```bash
# 1. Перейти в проект
cd /opt/insflow-system

# 2. Запустить получение сертификатов
bash scripts/ssl/obtain-certificates-docker.sh

# 3. Проверить сертификаты
ls -la letsencrypt/live/
```

### Проверка доступности доменов:
```bash
# Проверить DNS
nslookup insflow.ru
nslookup zs.insflow.ru
nslookup insflow.tw1.su
nslookup zs.insflow.tw1.su

# Проверить HTTP доступность
curl -I http://insflow.ru/
curl -I http://zs.insflow.ru/
curl -I http://insflow.tw1.su/
curl -I http://zs.insflow.tw1.su/
```

## Возможные проблемы и решения

### 1. DNS не настроен
**Проблема**: Домены не указывают на сервер
**Решение**: Настроить A-записи в DNS

### 2. Порты заблокированы
**Проблема**: Порты 80/443 недоступны
**Решение**: Открыть порты в firewall

### 3. Домены недоступны
**Проблема**: nginx не отвечает на запросы
**Решение**: Проверить статус nginx контейнера

### 4. Rate limit Let's Encrypt
**Проблема**: Слишком много попыток получения сертификатов
**Решение**: Подождать или использовать staging окружение

## Следующие шаги

1. **Проверить DNS настройки** - убедиться что домены указывают на сервер
2. **Запустить новый deployment** - система автоматически попробует получить сертификаты
3. **Мониторить логи** - проверить `ssl-generation.log` при неудаче
4. **Ручное тестирование** - если автоматическое получение не работает

## Автоматическое обновление

После успешного получения сертификатов:
- Certbot контейнер будет автоматически обновлять сертификаты
- Cron задача на хосте не нужна (все в Docker)
- Сертификаты обновляются каждые 12 часов