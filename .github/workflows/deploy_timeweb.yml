name: üöÄ Deploy to Timeweb with HTTPS

on:
  push:
    branches: [ main ]

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}:timeweb-latest
  PROJECT_PATH: /opt/insflow-system
  SSL_EMAIL: admin@insflow.ru
  DOMAINS_PRIMARY: insflow.ru,zs.insflow.ru
  DOMAINS_TECHNICAL: insflow.tw1.su,zs.insflow.tw1.su

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º buildx (–¥–ª—è –∫—ç—à–∏—Ä—É–µ–º—ã—Ö multi-arch —Å–±–æ—Ä–æ–∫)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3Ô∏è‚É£ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 4Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ —Å –∫—ç—à–µ–º (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–µ–≥ –¥–ª—è Timeweb)
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # 5Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb —á–µ—Ä–µ–∑ SSH
    - name: Deploy to Timeweb
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TIMEWEB_HOST }}
        username: ${{ secrets.TIMEWEB_USERNAME }}
        key: ${{ secrets.TIMEWEB_SSH_KEY }}
        port: ${{ secrets.TIMEWEB_PORT }}
        script: |
          set -e  # –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
          
          echo "‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–æ–µ–∫—Ç..."
          cd ${{ env.PROJECT_PATH }}
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
          git fetch origin main
          git reset --hard origin/main
          
          echo "‚û°Ô∏è –û–±–Ω–æ–≤–ª—è–µ–º .env..."
          cat > .env << EOF
          SECRET_KEY=${{ secrets.TIMEWEB_SECRET_KEY }}
          DB_NAME=${{ secrets.TIMEWEB_DB_NAME }}
          DB_USER=${{ secrets.TIMEWEB_DB_USER }}
          DB_PASSWORD=${{ secrets.TIMEWEB_DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          DB_ENGINE=django.db.backends.postgresql
          ALLOWED_HOSTS=${{ secrets.TIMEWEB_ALLOWED_HOSTS }}
          DOCKER_IMAGE=${{ env.DOCKER_IMAGE }}
          
          # Security settings for production (HTTPS enabled)
          DEBUG=False
          SESSION_COOKIE_SECURE=True
          CSRF_COOKIE_SECURE=True
          SECURE_HSTS_SECONDS=31536000
          SECURE_HSTS_INCLUDE_SUBDOMAINS=True
          SECURE_HSTS_PRELOAD=True
          SECURE_SSL_REDIRECT=True
          
          # Domain-specific settings for landing page
          MAIN_DOMAINS=${{ secrets.TIMEWEB_MAIN_DOMAINS }}
          SUBDOMAINS=${{ secrets.TIMEWEB_SUBDOMAINS }}
          
          # Static files configuration
          STATIC_URL=/static/
          MEDIA_URL=/media/
          
          # SSL Certificate settings
          SSL_ENABLED=True
          SSL_EMAIL=${{ env.SSL_EMAIL }}
          EOF
          
          echo "‚û°Ô∏è –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry..."
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "‚û°Ô∏è –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è rate limit..."
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            echo "‚úÖ Docker Hub login —É—Å–ø–µ—à–µ–Ω"
          else
            echo "‚ö†Ô∏è Docker Hub credentials –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –≤–æ–∑–º–æ–∂–Ω—ã rate limit –æ—à–∏–±–∫–∏"
          fi
          
          echo "‚û°Ô∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π Docker-–æ–±—Ä–∞–∑..."
          docker pull ${{ env.DOCKER_IMAGE }}
          
          echo "‚û°Ô∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker pull postgres:15 || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å postgres:15"
          docker pull nginx:1.25-alpine || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å nginx:1.25-alpine"
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã..."
          
          # Function to enable fallback mode
          enable_fallback_mode() {
            echo "‚ùå –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ fallback —Ä–µ–∂–∏–º (HTTP-only)"
            
            # Update .env to disable HTTPS features
            sed -i 's/SESSION_COOKIE_SECURE=True/SESSION_COOKIE_SECURE=False/' .env
            sed -i 's/CSRF_COOKIE_SECURE=True/CSRF_COOKIE_SECURE=False/' .env
            sed -i 's/SECURE_SSL_REDIRECT=True/SECURE_SSL_REDIRECT=False/' .env
            sed -i 's/SECURE_HSTS_SECONDS=31536000/SECURE_HSTS_SECONDS=0/' .env
            sed -i 's/SECURE_HSTS_INCLUDE_SUBDOMAINS=True/SECURE_HSTS_INCLUDE_SUBDOMAINS=False/' .env
            sed -i 's/SECURE_HSTS_PRELOAD=True/SECURE_HSTS_PRELOAD=False/' .env
            sed -i 's/SSL_ENABLED=True/SSL_ENABLED=False/' .env
            
            echo "‚ö†Ô∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –≤ HTTP-only —Ä–µ–∂–∏–º–µ"
          }
          
          # Make SSL scripts executable
          chmod +x scripts/ssl/*.sh || {
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å SSL —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏"
            enable_fallback_mode
          }
          
          # Check DNS resolution for domains first
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤..."
          dns_check_failed=false
          
          for domain_set in "${{ env.DOMAINS_PRIMARY }}" "${{ env.DOMAINS_TECHNICAL }}"; do
            IFS=',' read -ra domains <<< "$domain_set"
            for domain in "${domains[@]}"; do
              if ! nslookup "$domain" > /dev/null 2>&1; then
                echo "‚ùå DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–ª—è $domain"
                dns_check_failed=true
              else
                echo "‚úÖ DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ OK –¥–ª—è $domain"
              fi
            done
          done
          
          if [ "$dns_check_failed" = true ]; then
            echo "‚ùå DNS –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–æ–º–µ–Ω–æ–≤"
            enable_fallback_mode
          else
            echo "‚úÖ DNS –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤"
            
            # Check if certificates already exist and are valid
            if scripts/ssl/check-certificates.sh --quiet 2>/dev/null; then
              echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã"
            else
              echo "‚ö†Ô∏è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
              
              # Try to obtain certificates with Docker-based approach
              echo "‚û°Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Docker..."
              chmod +x scripts/ssl/obtain-certificates-docker.sh
              if timeout 600 bash scripts/ssl/obtain-certificates-docker.sh 2>&1 | tee ssl-generation.log; then
                echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã"
                
                # Verify certificates were actually created
                echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã..."
                sleep 3  # Wait for file system sync
                
                if [[ -f "letsencrypt/live/insflow.ru/fullchain.pem" ]] && [[ -f "letsencrypt/live/insflow.tw1.su/fullchain.pem" ]]; then
                  echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
                  
                  # Show certificate info
                  echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö:"
                  ls -la letsencrypt/live/*/fullchain.pem 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö"
                else
                  echo "‚ùå SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã, –Ω–æ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ–∂–∏–¥–∞–µ–º–æ–º –º–µ—Å—Ç–µ"
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ letsencrypt –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
                  ls -la letsencrypt/live/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è letsencrypt/live –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
                  echo "üìã –õ–æ–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:"
                  cat ssl-generation.log || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
                  enable_fallback_mode
                fi
              else
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (timeout –∏–ª–∏ –æ—à–∏–±–∫–∞)"
                echo "üìã –õ–æ–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:"
                cat ssl-generation.log || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
                enable_fallback_mode
              fi
            fi
          fi
          
          # Show final SSL status
          if grep -q "SSL_ENABLED=True" .env; then
            echo "‚úÖ SSL –≤–∫–ª—é—á–µ–Ω - —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS"
          else
            echo "‚ö†Ô∏è SSL –æ—Ç–∫–ª—é—á–µ–Ω - —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP-only —Ä–µ–∂–∏–º"
          fi
          
          echo "‚û°Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
          if grep -q "SSL_ENABLED=True" .env; then
            echo "üîí –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx"
            # Copy HTTPS config and start with SSL profile
            cp nginx-timeweb/default-https.conf nginx-timeweb/default.conf
            COMPOSE_PROFILES="ssl"
          else
            echo "üîì –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTP-only –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx"
            # Copy HTTP config and start without SSL profile
            cp nginx-timeweb/default-http.conf nginx-timeweb/default.conf
            COMPOSE_PROFILES=""
          fi
          
          echo "‚û°Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º docker-compose..."
          docker-compose -f docker-compose.timeweb.yml down --remove-orphans
          COMPOSE_PROFILES="$COMPOSE_PROFILES" docker-compose -f docker-compose.timeweb.yml up -d --force-recreate
          
          echo "‚û°Ô∏è –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 30
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker-compose -f docker-compose.timeweb.yml ps
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ web –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          docker-compose -f docker-compose.timeweb.yml logs --tail=50 web
          
          echo "‚û°Ô∏è –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
          if docker-compose -f docker-compose.timeweb.yml exec -T web python manage.py migrate --noinput; then
            echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏:"
            docker-compose -f docker-compose.timeweb.yml logs --tail=100 web
            docker-compose -f docker-compose.timeweb.yml logs --tail=50 db
            exit 1
          fi
          
          echo "‚û°Ô∏è –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
          if docker-compose -f docker-compose.timeweb.yml exec -T web python manage.py collectstatic --noinput; then
            echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–æ–±—Ä–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤"
            docker-compose -f docker-compose.timeweb.yml logs --tail=50 web
            exit 1
          fi
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker-compose -f docker-compose.timeweb.yml ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º healthcheck..."
          if docker-compose -f docker-compose.timeweb.yml exec -T web python /app/simple_healthcheck.py; then
            echo "‚úÖ Healthcheck –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ùå Healthcheck –Ω–µ –ø—Ä–æ—à–µ–ª!"
            exit 1
          fi
          
          echo "‚û°Ô∏è –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ nginx..."
          # Wait for nginx to be ready
          for i in {1..30}; do
            if docker-compose -f docker-compose.timeweb.yml ps nginx | grep -q "Up"; then
              echo "‚úÖ Nginx –≥–æ—Ç–æ–≤!"
              break
            fi
            echo "‚è≥ –û–∂–∏–¥–∞–µ–º nginx... ($i/30)"
            sleep 2
          done
          
          echo "‚û°Ô∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints..."
          # Test HTTP endpoints (should redirect to HTTPS if SSL is enabled)
          if curl -f -s http://localhost/healthz/ > /dev/null; then
            echo "‚úÖ Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç!"
          else
            echo "‚ùå Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ nginx..."
            docker-compose -f docker-compose.timeweb.yml logs --tail=20 nginx
          fi
          
          # Test HTTPS endpoints if SSL is enabled
          if grep -q "SSL_ENABLED=True" .env; then
            echo "‚û°Ô∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º HTTPS endpoints..."
            
            # Wait for SSL to be ready
            sleep 10
            
            # Test HTTPS health endpoint
            if curl -f -s -k https://localhost/healthz/ > /dev/null; then
              echo "‚úÖ HTTPS Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ùå HTTPS Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
            fi
            
            # Test HTTPS landing page
            if curl -f -s -k https://localhost/landing/health/ > /dev/null; then
              echo "‚úÖ HTTPS Landing page health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ùå HTTPS Landing page health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
            fi
            
            # Test HTTPS static files
            if curl -f -s -k https://localhost/static/css/landing.css > /dev/null; then
              echo "‚úÖ HTTPS Landing CSS —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω!"
            else
              echo "‚ùå HTTPS Landing CSS —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
            fi
            
            # Test HTTP to HTTPS redirect
            if curl -s -o /dev/null -w "%{http_code}" http://localhost/healthz/ | grep -q "301\|302"; then
              echo "‚úÖ HTTP to HTTPS redirect —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            else
              echo "‚ö†Ô∏è HTTP to HTTPS redirect –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
            fi
          else
            echo "‚ö†Ô∏è SSL –æ—Ç–∫–ª—é—á–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º HTTPS —Ç–µ—Å—Ç—ã"
          fi
          
          echo "‚û°Ô∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü—É..."
          if curl -f -s http://localhost/landing/health/ > /dev/null; then
            echo "‚úÖ Landing page health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç!"
          else
            echo "‚ùå Landing page health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
            curl -I http://localhost/landing/ || echo "–õ–µ–Ω–¥–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
          fi
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
          if curl -f -s http://localhost/static/css/landing.css > /dev/null; then
            echo "‚úÖ Landing CSS —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω!"
          else
            echo "‚ùå Landing CSS —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
            ls -la staticfiles/css/ || echo "–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          fi
          
          echo "‚û°Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
          if docker-compose -f docker-compose.timeweb.yml exec -T web bash /app/scripts/verify_landing_deployment.sh; then
            echo "‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ö†Ô∏è –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–∫–∞–∑–∞–ª–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)"
          fi
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
          if grep -q "SSL_ENABLED=True" .env; then
            if scripts/ssl/check-certificates.sh; then
              echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã!"
            else
              echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏"
            fi
            
            echo "‚û°Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
            if scripts/ssl/ssl-cron-setup.sh; then
              echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞!"
            else
              echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
            fi
          else
            echo "‚ö†Ô∏è SSL –æ—Ç–∫–ª—é—á–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
          fi
          
          echo "‚û°Ô∏è –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTPS —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏..."
          if grep -q "SSL_ENABLED=True" .env; then
            # Test all domains if accessible
            for domain in ${{ env.DOMAINS_PRIMARY }} ${{ env.DOMAINS_TECHNICAL }}; do
              domain=$(echo $domain | tr ',' ' ')
              for d in $domain; do
                echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ–º–µ–Ω: $d"
                # Note: This will only work if domains are properly configured and accessible
                if timeout 10 curl -f -s -I "https://$d/healthz/" > /dev/null 2>&1; then
                  echo "‚úÖ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è $d"
                else
                  echo "‚ö†Ô∏è HTTPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è $d (–≤–æ–∑–º–æ–∂–Ω–æ, DNS –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)"
                fi
              done
            done
          fi
          
          echo "‚û°Ô∏è –ß–∏—Å—Ç–∏–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker image prune -f
          
          echo "‚û°Ô∏è –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏..."
          cat > deployment_report.txt << EOF
          ===== TIMEWEB DEPLOYMENT REPORT =====
          Deployment Time: $(date)
          Git Commit: ${{ github.sha }}
          Docker Image: ${{ env.DOCKER_IMAGE }}
          
          SSL Status: $(grep "SSL_ENABLED=" .env | cut -d= -f2)
          HTTPS Redirect: $(grep "SECURE_SSL_REDIRECT=" .env | cut -d= -f2)
          
          Configured Domains:
          - Primary: ${{ env.DOMAINS_PRIMARY }}
          - Technical: ${{ env.DOMAINS_TECHNICAL }}
          
          Container Status:
          $(docker-compose -f docker-compose.timeweb.yml ps --format "table {{.Names}}\t{{.Status}}")
          
          SSL Certificate Status:
          EOF
          
          if grep -q "SSL_ENABLED=True" .env; then
            scripts/ssl/check-certificates.sh --quiet >> deployment_report.txt 2>&1 || echo "Certificate check failed" >> deployment_report.txt
          else
            echo "SSL disabled - no certificates to check" >> deployment_report.txt
          fi
          
          echo "EOF" >> deployment_report.txt
          
          echo "‚û°Ô∏è –û—Ç—á–µ—Ç –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏:"
          cat deployment_report.txt
          
          if grep -q "SSL_ENABLED=True" .env; then
            echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb —Å HTTPS –∏ –ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü–µ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
            echo "üîí HTTPS –∞–∫—Ç–∏–≤–µ–Ω –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤"
            echo "üìã –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è –î–µ–ø–ª–æ–π –Ω–∞ Timeweb –∑–∞–≤–µ—Ä—à—ë–Ω –≤ fallback —Ä–µ–∂–∏–º–µ (–±–µ–∑ HTTPS)"
            echo "üîì –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ HTTP-only —Ä–µ–∂–∏–º–µ"
            echo "üìã –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è HTTPS –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å DNS –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
          fi
          
          echo ""
          echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:"
          if grep -q "SSL_ENABLED=True" .env; then
            echo "  - https://insflow.ru (–ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü–∞)"
            echo "  - https://zs.insflow.ru (Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)"
            echo "  - https://insflow.tw1.su (–ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∑–µ—Ä–∫–∞–ª–æ)"
            echo "  - https://zs.insflow.tw1.su (Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∑–µ—Ä–∫–∞–ª–æ)"
          else
            echo "  - http://insflow.tw1.su (–ª–µ–Ω–¥–∏–Ω–≥-—Å—Ç—Ä–∞–Ω–∏—Ü–∞)"
            echo "  - http://zs.insflow.tw1.su (Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)"
          fi

    # 6Ô∏è‚É£ Post-deployment notification and cleanup
    - name: Post-deployment notification
      if: always()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TIMEWEB_HOST }}
        username: ${{ secrets.TIMEWEB_USERNAME }}
        key: ${{ secrets.TIMEWEB_SSH_KEY }}
        port: ${{ secrets.TIMEWEB_PORT }}
        script: |
          cd ${{ env.PROJECT_PATH }}
          
          # Check final deployment status
          if docker-compose -f docker-compose.timeweb.yml ps | grep -q "Up"; then
            deployment_status="SUCCESS"
          else
            deployment_status="FAILED"
          fi
          
          ssl_status=$(grep "SSL_ENABLED=" .env | cut -d= -f2)
          
          echo "üìä Final Deployment Status: $deployment_status"
          echo "üîí SSL Status: $ssl_status"
          
          # Log deployment event
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Deployment $deployment_status (SSL: $ssl_status)" >> /var/log/deployment.log
          
          # Optional: Send notification (webhook, email, etc.)
          # This can be extended to send notifications to external services
          if [ "$deployment_status" = "FAILED" ]; then
            echo "‚ùå Deployment failed - manual intervention may be required"
            exit 1
          else
            echo "‚úÖ Deployment completed successfully"
          fi