name: üöÄ Deploy to Timeweb

on:
  push:
    branches: [ main ]

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}:timeweb-latest
  PROJECT_PATH: /opt/insflow-system

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º buildx (–¥–ª—è –∫—ç—à–∏—Ä—É–µ–º—ã—Ö multi-arch —Å–±–æ—Ä–æ–∫)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3Ô∏è‚É£ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 4Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ —Å –∫—ç—à–µ–º (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–µ–≥ –¥–ª—è Timeweb)
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # 5Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb —á–µ—Ä–µ–∑ SSH
    - name: Deploy to Timeweb
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TIMEWEB_HOST }}
        username: ${{ secrets.TIMEWEB_USERNAME }}
        key: ${{ secrets.TIMEWEB_SSH_KEY }}
        port: ${{ secrets.TIMEWEB_PORT }}
        script: |
          set -e  # –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
          
          echo "‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–æ–µ–∫—Ç..."
          cd ${{ env.PROJECT_PATH }}
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
          git fetch origin main
          git reset --hard origin/main
          
          echo "‚û°Ô∏è –û–±–Ω–æ–≤–ª—è–µ–º .env..."
          cat > .env << EOF
          SECRET_KEY=${{ secrets.TIMEWEB_SECRET_KEY }}
          DB_NAME=${{ secrets.TIMEWEB_DB_NAME }}
          DB_USER=${{ secrets.TIMEWEB_DB_USER }}
          DB_PASSWORD=${{ secrets.TIMEWEB_DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          ALLOWED_HOSTS=${{ secrets.TIMEWEB_ALLOWED_HOSTS }}
          DOCKER_IMAGE=${{ env.DOCKER_IMAGE }}
          EOF
          
          echo "‚û°Ô∏è –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry..."
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "‚û°Ô∏è –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è rate limit..."
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            echo "‚úÖ Docker Hub login —É—Å–ø–µ—à–µ–Ω"
          else
            echo "‚ö†Ô∏è Docker Hub credentials –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –≤–æ–∑–º–æ–∂–Ω—ã rate limit –æ—à–∏–±–∫–∏"
          fi
          
          echo "‚û°Ô∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π Docker-–æ–±—Ä–∞–∑..."
          docker pull ${{ env.DOCKER_IMAGE }}
          
          echo "‚û°Ô∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker pull postgres:15 || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å postgres:15"
          docker pull nginx:1.25-alpine || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å nginx:1.25-alpine"
          
          echo "‚û°Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º docker-compose..."
          docker-compose -f docker-compose.timeweb.yml down --remove-orphans
          docker-compose -f docker-compose.timeweb.yml up -d --force-recreate
          
          echo "‚û°Ô∏è –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 15
          
          echo "‚û°Ô∏è –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
          docker-compose -f docker-compose.timeweb.yml exec -T web python manage.py migrate --noinput
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          docker-compose -f docker-compose.timeweb.yml ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º healthcheck..."
          if docker-compose -f docker-compose.timeweb.yml exec -T web python /app/healthcheck.py; then
            echo "‚úÖ Healthcheck –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ùå Healthcheck –Ω–µ –ø—Ä–æ—à–µ–ª!"
            exit 1
          fi
          
          echo "‚û°Ô∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints..."
          if curl -f -s http://localhost/healthz/ > /dev/null; then
            echo "‚úÖ Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç!"
          else
            echo "‚ùå Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
          fi
          
          echo "‚û°Ô∏è –ß–∏—Å—Ç–∏–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã..."
          docker image prune -f
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ Timeweb —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"