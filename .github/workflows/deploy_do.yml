name: ðŸš€ Deploy to DigitalOcean

on:
  push:
    branches: [ main ]

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}:latest
  PROJECT_PATH: /opt/insurance-system

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1ï¸âƒ£ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð´
    - name: Checkout code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ buildx (Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€ÑƒÐµÐ¼Ñ‹Ñ… multi-arch ÑÐ±Ð¾Ñ€Ð¾Ðº)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3ï¸âƒ£ Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 4ï¸âƒ£ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÑˆ Ð¾Ð±Ñ€Ð°Ð·Ð° Ñ ÐºÑÑˆÐµÐ¼
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # 5ï¸âƒ£ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ñ‡ÐµÑ€ÐµÐ· SSH
    - name: Deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        passphrase: ${{ secrets.DO_PASSPHRASE }}
        port: ${{ secrets.DO_PORT }}
        script: |
          set -e
          
          PROJECT_PATH="${{ env.PROJECT_PATH }}"
          DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"
          
          # Function to wait for service health
          wait_for_service_health() {
              local service_name=$1
              local max_attempts=$2
              local attempt=1
              
              echo "â³ Waiting for $service_name to be healthy..."
              
              while [ $attempt -le $max_attempts ]; do
                  if docker-compose ps --format "table {{.Names}}\t{{.Status}}" | grep -q "$service_name.*healthy"; then
                      echo "âœ… $service_name is healthy!"
                      return 0
                  fi
                  
                  echo "   Attempt $attempt/$max_attempts - $service_name not ready yet..."
                  sleep 10
                  attempt=$((attempt + 1))
              done
              
              echo "âŒ $service_name failed to become healthy after $max_attempts attempts"
              return 1
          }
          
          # Function to test endpoint
          test_endpoint() {
              local url=$1
              local description=$2
              local max_attempts=${3:-6}
              local attempt=1
              
              echo "ðŸ” Testing $description..."
              
              while [ $attempt -le $max_attempts ]; do
                  if curl -f -s --connect-timeout 5 --max-time 10 "$url" > /dev/null; then
                      echo "âœ… $description is working!"
                      return 0
                  fi
                  
                  echo "   Attempt $attempt/$max_attempts - $description not ready yet..."
                  sleep 10
                  attempt=$((attempt + 1))
              done
              
              echo "âŒ $description failed after $max_attempts attempts"
              return 1
          }
          
          echo "ðŸš€ Starting improved Digital Ocean deployment..."
          
          echo "âž¡ï¸ Changing to project directory..."
          cd $PROJECT_PATH
          
          echo "âž¡ï¸ Fetching latest code..."
          git fetch origin main
          git reset --hard origin/main
          
          echo "âž¡ï¸ Updating environment configuration..."
          cat > .env << EOF
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          DOCKER_IMAGE=$DOCKER_IMAGE
          EOF
          
          echo "âž¡ï¸ Logging into GitHub Container Registry..."
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "âž¡ï¸ Pulling latest Docker image..."
          docker pull $DOCKER_IMAGE
          
          echo "âž¡ï¸ Stopping existing services..."
          docker-compose down --remove-orphans
          
          echo "âž¡ï¸ Starting database service first..."
          docker-compose up -d db
          
          echo "âž¡ï¸ Waiting for database to be ready..."
          sleep 30
          for i in {1..12}; do
              if docker-compose exec -T db pg_isready -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }}; then
                  echo "âœ… Database is ready!"
                  break
              fi
              echo "   Waiting for database... ($i/12)"
              sleep 5
          done
          
          echo "âž¡ï¸ Starting web service..."
          docker-compose up -d web
          
          echo "âž¡ï¸ Waiting for web service to be ready..."
          sleep 60
          for i in {1..18}; do
              if docker-compose exec -T web curl -f --connect-timeout 5 http://localhost:8000/healthz/; then
                  echo "âœ… Web service is ready!"
                  break
              fi
              echo "   Waiting for web service... ($i/18)"
              sleep 10
          done
          
          echo "âž¡ï¸ Running database migrations..."
          docker-compose exec -T web python manage.py migrate --noinput
          
          echo "âž¡ï¸ Collecting static files..."
          docker-compose exec -T web python manage.py collectstatic --noinput
          
          echo "âž¡ï¸ Testing web service directly..."
          test_endpoint "http://localhost:8000/healthz/" "Web service health check"
          
          echo "âž¡ï¸ Starting nginx service..."
          docker-compose up -d nginx
          
          echo "âž¡ï¸ Waiting for nginx to be ready..."
          sleep 30
          
          echo "âž¡ï¸ Testing complete application..."
          test_endpoint "http://localhost/healthz/" "Application through nginx"
          
          echo "âž¡ï¸ Final service status check..."
          docker-compose ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "âž¡ï¸ Running comprehensive health check..."
          if docker-compose exec -T web python /app/healthcheck.py; then
              echo "âœ… Comprehensive health check passed!"
          else
              echo "âš ï¸  Comprehensive health check had issues, but basic functionality is working"
          fi
          
          echo "âž¡ï¸ Cleaning up unused images..."
          docker image prune -f
          
          echo "âœ… Deployment completed successfully!"
          echo ""
          echo "ðŸŒ Application should be available at:"
          echo "   - http://onbr.site"
          echo "   - http://64.227.75.233"