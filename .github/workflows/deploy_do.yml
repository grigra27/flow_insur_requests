name: üöÄ Deploy to DigitalOcean

on:
  push:
    branches: [ main ]

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}:latest
  PROJECT_PATH: /opt/insurance-system

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º buildx (–¥–ª—è –∫—ç—à–∏—Ä—É–µ–º—ã—Ö multi-arch —Å–±–æ—Ä–æ–∫)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3Ô∏è‚É£ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 4Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–∞ —Å –∫—ç—à–µ–º
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # 5Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SSH
    - name: Deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        passphrase: ${{ secrets.DO_PASSPHRASE }}
        port: ${{ secrets.DO_PORT }}
        envs: SECRET_KEY,DB_NAME,DB_USER,DB_PASSWORD,ALLOWED_HOSTS,DOCKER_IMAGE,GITHUB_TOKEN,GITHUB_ACTOR
        script: |
          export SECRET_KEY="${{ secrets.SECRET_KEY }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export ALLOWED_HOSTS="${{ secrets.ALLOWED_HOSTS }}"
          export DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          
          cd ${{ env.PROJECT_PATH }}
          chmod +x scripts/deploy_do_improved.sh
          ./scripts/deploy_do_improved.sh