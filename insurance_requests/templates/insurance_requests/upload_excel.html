{% extends 'base.html' %}

{% block title %}Загрузка Excel файла - {{ block.super }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-upload"></i> Загрузка Excel файла с заявкой</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.application_format.id_for_label }}" class="form-label">
                            {{ form.application_format.label }}
                        </label>
                        {{ form.application_format }}
                        {% if form.application_format.help_text %}
                            <div class="form-text">{{ form.application_format.help_text }}</div>
                        {% endif %}
                        {% if form.application_format.errors %}
                            <div class="text-danger">
                                {% for error in form.application_format.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.application_type.id_for_label }}" class="form-label">
                            {{ form.application_type.label }}
                        </label>
                        {{ form.application_type }}
                        {% if form.application_type.help_text %}
                            <div class="form-text">{{ form.application_type.help_text }}</div>
                        {% endif %}
                        {% if form.application_type.errors %}
                            <div class="text-danger">
                                {% for error in form.application_type.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.excel_file.id_for_label }}" class="form-label">
                            {{ form.excel_file.label }}
                        </label>
                        {{ form.excel_file }}
                        {% if form.excel_file.help_text %}
                            <div class="form-text">{{ form.excel_file.help_text }}</div>
                        {% endif %}
                        {% if form.excel_file.errors %}
                            <div class="text-danger">
                                {% for error in form.excel_file.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Требования к файлу:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Формат: .xls, .xlsx или .xltx</li>
                            <li>Максимальный размер: 10 МБ</li>
                            <li>Данные должны быть в соответствующем формате заявки (КАСКО/спецтехника или имущество)</li>
                            <li><strong>Важно:</strong> Выберите правильный формат заявки перед загрузкой файла</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'insurance_requests:request_list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Назад
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Загрузить и обработать
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>Структура Excel файла - формат КАСКО/спецтехника</h5>
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Внимание!</strong> Таблица ниже показывает структуру для формата <strong>"КАСКО/спецтехника"</strong>. 
                Для формата <strong>"имущество"</strong> используется другая структура извлечения данных.
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Поле</th>
                            <th><i class="bi bi-building"></i> Заявка от юр.лица</th>
                            <th><i class="bi bi-person"></i> Заявка от ИП</th>
                            <th>Описание</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Имя клиента</strong></td>
                            <td>D7</td>
                            <td>D7</td>
                            <td>Название организации или ФИО</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>ИНН</strong></td>
                            <td>D9</td>
                            <td><span class="text-danger">D10</span></td>
                            <td>ИНН клиента (10 или 12 цифр)</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Тип страхования</strong></td>
                            <td>D21/D22</td>
                            <td><span class="text-danger">D22/D23</span></td>
                            <td>КАСКО / спецтехника / другое</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Период "1 год"</strong></td>
                            <td>N17</td>
                            <td><span class="text-danger">N18</span></td>
                            <td>Наличие отметки = страхование на 1 год</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Период "весь срок лизинга"</strong></td>
                            <td>N18</td>
                            <td><span class="text-danger">N19</span></td>
                            <td>Наличие отметки = страхование на весь срок лизинга</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Франшиза</strong></td>
                            <td>D29</td>
                            <td><span class="text-danger">D30</span></td>
                            <td>Наличие значения = НЕТ франшизы</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Рассрочка</strong></td>
                            <td>F34</td>
                            <td><span class="text-danger">F35</span></td>
                            <td>Наличие значения = НЕТ рассрочки</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Автозапуск</strong></td>
                            <td>M24</td>
                            <td><span class="text-danger">M25</span></td>
                            <td>Значение "нет" = нет автозапуска</td>
                        </tr>
                        <tr>
                            <td><strong>Номер ДФА</strong></td>
                            <td>HIJ2</td>
                            <td>HIJ2</td>
                            <td>Номер договора финансовой аренды</td>
                        </tr>
                        <tr>
                            <td><strong>Филиал</strong></td>
                            <td>CDEF4</td>
                            <td>CDEF4</td>
                            <td>Название филиала</td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Информация о ТС</strong></td>
                            <td>CDEFGHI43/45/47/49</td>
                            <td><span class="text-danger">CDEFGHI44/46/48/50</span></td>
                            <td>Описание предмета лизинга</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="alert alert-light mt-3">
                <i class="bi bi-lightbulb"></i>
                <strong>Пояснение:</strong>
                <ul class="mb-0 mt-2">
                    <li><span class="text-danger">Красным цветом</span> выделены ячейки, которые отличаются для заявок от ИП</li>
                    <li><span class="bg-warning px-1">Желтым фоном</span> выделены строки, где есть различия между типами заявок</li>
                    <li>Заявки от ИП имеют дополнительную строку в позиции 8, что смещает все данные ниже этой строки на одну позицию вниз</li>
                    <li>Данные в строках 1-8 остаются в тех же ячейках для обоих типов заявок</li>
                </ul>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-building"></i> Пример заявки от юр.лица</h6>
                        </div>
                        <div class="card-body">
                            <small class="text-muted">Стандартная структура файла:</small>
                            <div class="mt-2">
                                <code>D7: ООО "АЛТЫН ЯР"</code><br>
                                <code>D9: 1234567890</code> <span class="text-muted">(ИНН 10 цифр)</span><br>
                                <code>D21: КАСКО</code> <span class="text-muted">(тип страхования)</span><br>
                                <code>N17: ✓</code> <span class="text-muted">(период 1 год)</span><br>
                                <code>D29: </code> <span class="text-muted">(есть значение = НЕТ франшизы)</span><br>
                                <code>M24: нет</code> <span class="text-muted">(автозапуск)</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-person"></i> Пример заявки от ИП</h6>
                        </div>
                        <div class="card-body">
                            <small class="text-muted">Структура с дополнительной строкой 8:</small>
                            <div class="mt-2">
                                <code>D7: ИП Иванов И.И.</code><br>
                                <code>D8: Дополнительная информация</code> <span class="badge bg-warning text-dark">НОВАЯ СТРОКА</span><br>
                                <code>D10: 123456789012</code> <span class="text-muted">(ИНН 12 цифр)</span><br>
                                <code>D22: КАСКО</code> <span class="text-muted">(смещено с D21)</span><br>
                                <code>N18: ✓</code> <span class="text-muted">(смещено с N17)</span><br>
                                <code>D30: </code> <span class="text-muted">(смещено с D29)</span><br>
                                <code>M25: нет</code> <span class="text-muted">(смещено с M24)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h5>Структура Excel файла - формат имущество</h5>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Формат "имущество"</strong> использует другую логику извлечения данных:
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Поле</th>
                                <th><i class="bi bi-building"></i> Заявка от юр.лица</th>
                                <th><i class="bi bi-person"></i> Заявка от ИП</th>
                                <th>Описание</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-success">
                                <td><strong>Тип страхования</strong></td>
                                <td>B22</td>
                                <td><span class="text-danger">B23</span></td>
                                <td>Если есть значение → "страхование имущества", иначе → "другое"</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Информация об имуществе</strong></td>
                                <td>CDEFGHIJ42</td>
                                <td><span class="text-danger">CDEFGHIJ43</span></td>
                                <td>Описание застрахованного имущества (одна строка, включая столбец J)</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Автозапуск</strong></td>
                                <td colspan="2" class="text-center">Всегда "НЕТ"</td>
                                <td>Для имущества автозапуск не применяется</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="table-secondary text-center">
                                    <em>Остальные поля (клиент, ИНН, ДФА, филиал, франшиза, рассрочка) извлекаются так же, как в формате КАСКО/спецтехника</em>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-warning mt-3">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Внимание!</strong> Неправильный выбор формата или типа заявки приведет к извлечению данных из неправильных ячеек. 
                Всегда проверяйте соответствие выбранных параметров структуре загружаемого файла.
            </div>
        </div>
    </div>
</div>
{% endblock %}