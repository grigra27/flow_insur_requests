{% extends 'base.html' %}
{% load tz %}

{% block title %}Редактирование {{ request.get_display_name }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-pencil"></i> Редактирование {{ request.get_display_name }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                        <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.client_name.id_for_label }}" class="form-label">
                                    {{ form.client_name.label }}
                                </label>
                                {{ form.client_name }}
                                {% if form.client_name.errors %}
                                <div class="text-danger">
                                    {% for error in form.client_name.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.inn.id_for_label }}" class="form-label">
                                    {{ form.inn.label }}
                                </label>
                                {{ form.inn }}
                                {% if form.inn.errors %}
                                <div class="text-danger">
                                    {% for error in form.inn.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.insurance_type.id_for_label }}" class="form-label">
                                    {{ form.insurance_type.label }}
                                </label>
                                {{ form.insurance_type }}
                                {% if form.insurance_type.errors %}
                                <div class="text-danger">
                                    {% for error in form.insurance_type.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.insurance_period.id_for_label }}" class="form-label">
                                    {{ form.insurance_period.label }}
                                </label>
                                {{ form.insurance_period }}
                                {% if form.insurance_period.help_text %}
                                <div class="form-text">{{ form.insurance_period.help_text }}</div>
                                {% endif %}
                                {% if form.insurance_period.errors %}
                                <div class="text-danger">
                                    {% for error in form.insurance_period.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>



                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.branch.id_for_label }}" class="form-label">
                                    {{ form.branch.label }}
                                </label>
                                {{ form.branch }}
                                {% if form.branch.errors %}
                                <div class="text-danger">
                                    {% for error in form.branch.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.dfa_number.id_for_label }}" class="form-label">
                                    {{ form.dfa_number.label }}
                                </label>
                                {{ form.dfa_number }}
                                {% if form.dfa_number.errors %}
                                <div class="text-danger">
                                    {% for error in form.dfa_number.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.manager_name.id_for_label }}" class="form-label">
                                    {{ form.manager_name.label }}
                                </label>
                                {{ form.manager_name }}
                                {% if form.manager_name.errors %}
                                <div class="text-danger">
                                    {% for error in form.manager_name.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.deal_status.id_for_label }}" class="form-label">
                                    {{ form.deal_status.label }}
                                </label>
                                {{ form.deal_status }}
                                {% if form.deal_status.errors %}
                                <div class="text-danger">
                                    {% for error in form.deal_status.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.vehicle_info.id_for_label }}" class="form-label">
                            {{ form.vehicle_info.label }}
                        </label>
                        {{ form.vehicle_info }}
                        {% if form.vehicle_info.errors %}
                        <div class="text-danger">
                            {% for error in form.vehicle_info.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Общие дополнительные параметры -->
                    <div class="mb-4 common-additional-fields">
                        <h6 class="text-muted mb-3">Необязательные параметры</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.creditor_bank.id_for_label }}" class="form-label">
                                        {{ form.creditor_bank.label }}
                                    </label>
                                    {{ form.creditor_bank }}
                                    {% if form.creditor_bank.errors %}
                                    <div class="text-danger">
                                        {% for error in form.creditor_bank.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.usage_purposes.id_for_label }}" class="form-label">
                                        {{ form.usage_purposes.label }}
                                    </label>
                                    {{ form.usage_purposes }}
                                    {% if form.usage_purposes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.usage_purposes.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Дополнительные параметры КАСКО/спецтехника -->
                    <div class="mb-4" id="casco-additional-fields">
                        <h6 class="text-muted mb-3">Дополнительные параметры КАСКО/спецтехника</h6>
                        
                        <div class="row">
                            <div class="col-md-6 casco-specific">
                                <div class="mb-3">
                                    <label for="{{ form.manufacturing_year.id_for_label }}" class="form-label">
                                        {{ form.manufacturing_year.label }}
                                    </label>
                                    {{ form.manufacturing_year }}
                                    <div class="form-text">Год выпуска предмета лизинга</div>
                                    {% if form.manufacturing_year.errors %}
                                    <div class="text-danger">
                                        {% for error in form.manufacturing_year.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 casco-specific">
                                <div class="mb-3">
                                    <label for="{{ form.key_completeness.id_for_label }}" class="form-label">
                                        {{ form.key_completeness.label }}
                                    </label>
                                    {{ form.key_completeness }}
                                    {% if form.key_completeness.errors %}
                                    <div class="text-danger">
                                        {% for error in form.key_completeness.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 casco-specific">
                                <div class="mb-3">
                                    <label for="{{ form.pts_psm.id_for_label }}" class="form-label">
                                        {{ form.pts_psm.label }}
                                    </label>
                                    {{ form.pts_psm }}
                                    {% if form.pts_psm.errors %}
                                    <div class="text-danger">
                                        {% for error in form.pts_psm.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 casco-specific">
                                <div class="mb-3">
                                    <label for="{{ form.telematics_complex.id_for_label }}" class="form-label">
                                        {{ form.telematics_complex.label }}
                                    </label>
                                    {{ form.telematics_complex }}
                                    {% if form.telematics_complex.errors %}
                                    <div class="text-danger">
                                        {% for error in form.telematics_complex.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Дополнительные параметры для страхования имущества -->
                    <div class="mb-4" id="property-additional-fields">
                        <h6 class="text-muted mb-3">Дополнительные параметры страхования имущества</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.insurance_territory.id_for_label }}" class="form-label">
                                        {{ form.insurance_territory.label }}
                                    </label>
                                    {{ form.insurance_territory }}
                                    {% if form.insurance_territory.errors %}
                                    <div class="text-danger">
                                        {% for error in form.insurance_territory.errors %}
                                        <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Пустая колонка для симметрии -->
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.response_deadline.id_for_label }}" class="form-label">
                            {{ form.response_deadline.label }}
                        </label>
                        {{ form.response_deadline }}
                        <div class="form-text">Время указывается в московском часовом поясе (МСК)</div>
                        {% if form.response_deadline.errors %}
                        <div class="text-danger">
                            {% for error in form.response_deadline.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3 notes-field">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            {{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                        {% if form.notes.help_text %}
                        <div class="form-text" id="notes-help">{{ form.notes.help_text }}</div>
                        {% endif %}
                        {% if form.notes.errors %}
                        <div class="text-danger">
                            {% for error in form.notes.errors %}
                            <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Дополнительные параметры -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Дополнительные параметры "с галочками" - <i>влияет на текст письма</i></h6>
                        
                        <!-- Общие параметры -->
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body py-2">
                                <h6 class="card-subtitle mb-2 text-muted small">Общие</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.has_franchise }}
                                            <label class="form-check-label" for="{{ form.has_franchise.id_for_label }}">
                                                {{ form.has_franchise.label }}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.has_installment }}
                                            <label class="form-check-label" for="{{ form.has_installment.id_for_label }}">
                                                {{ form.has_installment.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Параметры для КАСКО и СТ -->
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body py-2">
                                <h6 class="card-subtitle mb-2 text-muted small">КАСКО и СТ</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.has_autostart }}
                                            <label class="form-check-label" for="{{ form.has_autostart.id_for_label }}">
                                                {{ form.has_autostart.label }}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.has_casco_ce }}
                                            <label class="form-check-label" for="{{ form.has_casco_ce.id_for_label }}">
                                                {{ form.has_casco_ce.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Параметры для имущества -->
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body py-2">
                                <h6 class="card-subtitle mb-2 text-muted small">Имущество</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.has_transportation }}
                                            <label class="form-check-label" for="{{ form.has_transportation.id_for_label }}">
                                                {{ form.has_transportation.label }}
                                            </label>
                                            {% if form.has_transportation.errors %}
                                            <div class="text-danger">
                                                {% for error in form.has_transportation.errors %}
                                                <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.has_construction_work }}
                                            <label class="form-check-label" for="{{ form.has_construction_work.id_for_label }}">
                                                {{ form.has_construction_work.label }}
                                            </label>
                                            {% if form.has_construction_work.errors %}
                                            <div class="text-danger">
                                                {% for error in form.has_construction_work.errors %}
                                                <small>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'insurance_requests:request_detail' request.pk %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить изменения
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const notesInput = document.getElementById('{{ form.notes.id_for_label }}');
        const form = document.querySelector('form');
        const insuranceTypeSelect = document.getElementById('{{ form.insurance_type.id_for_label }}');
        const cascoFields = document.getElementById('casco-additional-fields');
        const propertyFields = document.getElementById('property-additional-fields');

        // Функция для показа/скрытия дополнительных полей в зависимости от типа страхования
        function toggleAdditionalFields() {
            if (!insuranceTypeSelect || !cascoFields || !propertyFields) return;
            
            const selectedType = insuranceTypeSelect.value;
            
            if (selectedType === 'КАСКО' || selectedType === 'страхование спецтехники') {
                cascoFields.style.display = 'block';
                propertyFields.style.display = 'none';
            } else if (selectedType === 'страхование имущества') {
                cascoFields.style.display = 'none';
                propertyFields.style.display = 'block';
            } else {
                // Для типа "другое" показываем все поля
                cascoFields.style.display = 'block';
                propertyFields.style.display = 'block';
            }
        }

        // Инициализация при загрузке страницы
        toggleAdditionalFields();

        // Обработчик изменения типа страхования
        if (insuranceTypeSelect) {
            insuranceTypeSelect.addEventListener('change', toggleAdditionalFields);
        }

        // Функция для отображения ошибок валидации
        function showFieldError(field, message) {
            // Удаляем предыдущие ошибки
            const existingError = field.parentNode.querySelector('.client-validation-error');
            if (existingError) {
                existingError.remove();
            }

            // Добавляем новую ошибку
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-danger client-validation-error';
            errorDiv.innerHTML = '<small>' + message + '</small>';
            field.parentNode.appendChild(errorDiv);

            // Добавляем класс ошибки к полю
            field.classList.add('is-invalid');
        }

        // Функция для очистки ошибок валидации
        function clearFieldError(field) {
            const existingError = field.parentNode.querySelector('.client-validation-error');
            if (existingError) {
                existingError.remove();
            }
            field.classList.remove('is-invalid');
        }

        // Функция валидации примечаний
        function validateNotes() {
            let isValid = true;

            if (notesInput) {
                // Очищаем предыдущие ошибки
                clearFieldError(notesInput);

                const notesValue = notesInput.value.trim();

                // Проверка максимальной длины
                if (notesValue.length > 2000) {
                    showFieldError(notesInput, 'Примечание не должно превышать 2000 символов');
                    isValid = false;
                }

                // Проверка минимальной длины (если поле не пустое)
                if (notesValue.length > 0 && notesValue.length < 3) {
                    showFieldError(notesInput, 'Примечание должно содержать минимум 3 символа');
                    isValid = false;
                }

                // Проверка на потенциально опасный контент
                const dangerousPatterns = [
                    /<script[^>]*>/i,
                    /<\/script>/i,
                    /javascript:/i,
                    /<iframe[^>]*>/i,
                    /<object[^>]*>/i,
                    /<embed[^>]*>/i
                ];

                for (const pattern of dangerousPatterns) {
                    if (pattern.test(notesValue)) {
                        showFieldError(notesInput, 'Примечание содержит недопустимые элементы');
                        isValid = false;
                        break;
                    }
                }

                // Обновляем счетчик символов
                updateCharacterCount();
            }

            return isValid;
        }

        // Функция для обновления счетчика символов
        function updateCharacterCount() {
            if (notesInput) {
                const currentLength = notesInput.value.length;
                const maxLength = 2000;
                
                let counterElement = document.getElementById('notes-char-counter');
                if (!counterElement) {
                    counterElement = document.createElement('div');
                    counterElement.id = 'notes-char-counter';
                    counterElement.className = 'form-text text-end';
                    notesInput.parentNode.appendChild(counterElement);
                }
                
                counterElement.textContent = `${currentLength}/${maxLength} символов`;
                
                // Изменяем цвет при приближении к лимиту
                if (currentLength > maxLength * 0.9) {
                    counterElement.className = 'form-text text-end text-warning';
                } else if (currentLength > maxLength) {
                    counterElement.className = 'form-text text-end text-danger';
                } else {
                    counterElement.className = 'form-text text-end text-muted';
                }
            }
        }





        // Обработчики событий для поля примечаний
        if (notesInput) {
            // Валидация при вводе текста
            notesInput.addEventListener('input', function() {
                updateCharacterCount();
                // Задержка валидации для лучшего UX
                clearTimeout(this.validationTimeout);
                this.validationTimeout = setTimeout(validateNotes, 500);
            });

            // Валидация при потере фокуса
            notesInput.addEventListener('blur', validateNotes);

            // Улучшение доступности
            notesInput.setAttribute('aria-label', 'Примечания к заявке');
            notesInput.setAttribute('aria-describedby', 'notes-help notes-char-counter');

            // Инициализация счетчика символов
            updateCharacterCount();
        }

        // Валидация при отправке формы
        if (form) {
            form.addEventListener('submit', function (e) {
                const notesValid = validateNotes();
                
                if (!notesValid) {
                    e.preventDefault();

                    // Прокручиваем к первому полю с ошибкой
                    const firstError = document.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }

                    // Показываем общее сообщение об ошибке
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                    let errorMessage = '<strong>Внимание!</strong> Пожалуйста, исправьте ошибки в полях перед сохранением:';
                    
                    if (!notesValid) {
                        errorMessage += '<br>• Проверьте содержимое поля примечаний';
                    }
                    
                    alertDiv.innerHTML = errorMessage + `
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                `;

                    // Вставляем предупреждение в начало формы
                    const existingAlert = form.querySelector('.alert-warning');
                    if (existingAlert) {
                        existingAlert.remove();
                    }
                    form.insertBefore(alertDiv, form.firstChild);
                }
            });
        }

        // Инициализация валидации при загрузке страницы
        if (notesInput) {
            validateNotes();
        }
    });
</script>

<style>
    /* Дополнительные стили для улучшения UX */
    .client-validation-error {
        margin-top: 0.25rem;
    }

    /* Стили для поля примечаний */
    .notes-field textarea {
        resize: vertical;
        min-height: 100px;
    }

    .notes-field textarea:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .notes-field textarea.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    #notes-char-counter {
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    #notes-char-counter.text-warning {
        font-weight: 500;
    }

    #notes-char-counter.text-danger {
        font-weight: 600;
    }

    /* Улучшение доступности для screen readers */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Стили для блоков дополнительных параметров */
    .card.border-0.bg-light {
        background-color: #f8f9fa !important;
        border-radius: 0.5rem;
    }

    .card.border-0.bg-light .card-body {
        padding: 0.75rem 1rem;
    }

    .card.border-0.bg-light .card-subtitle {
        font-weight: 600;
        color: #6c757d !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.75rem;
    }

    .card.border-0.bg-light .form-check {
        margin-bottom: 0.5rem;
    }

    .card.border-0.bg-light .form-check-label {
        font-size: 0.9rem;
        color: #495057;
    }

    .card.border-0.bg-light:hover {
        background-color: #e9ecef !important;
        transition: background-color 0.2s ease;
    }

    /* Стили для дополнительных полей КАСКО/имущество */
    #casco-additional-fields,
    #property-additional-fields {
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    #casco-additional-fields h6,
    #property-additional-fields h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }

    #casco-additional-fields .form-control,
    #property-additional-fields .form-control {
        border-color: #ced4da;
    }

    #casco-additional-fields .form-control:focus,
    #property-additional-fields .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Стили для блока общих дополнительных параметров */
    .common-additional-fields {
        border: 1px solid #d1ecf1;
        border-radius: 0.5rem;
        padding: 1rem;
        background-color: #f1f9fc;
        margin-bottom: 1rem;
    }

    .common-additional-fields h6 {
        color: #0c5460;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #bee5eb;
    }

    .common-additional-fields .form-control {
        border-color: #ced4da;
    }

    .common-additional-fields .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}