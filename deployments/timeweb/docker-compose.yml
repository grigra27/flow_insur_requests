version: "3.9"

# Timeweb HTTPS Deployment Configuration
# 
# SSL Certificate Volume Management:
# - Uses named volumes by default for portability
# - Can be configured to use bind mounts for production by setting:
#   SSL_VOLUME_TYPE=bind and SSL_CERTIFICATES_PATH=/opt/letsencrypt
#   ACME_VOLUME_TYPE=bind and ACME_CHALLENGE_PATH=/opt/acme-challenge
# 
# Environment Variables Required:
# - DOMAINS: Comma-separated list of domains for SSL certificates
# - SSL_EMAIL: Email for Let's Encrypt registration
# - CERTBOT_STAGING: Set to 'true' for testing (default: false)
#
# Usage:
# - For HTTP only: docker compose up db web nginx
# - For HTTPS: docker compose --profile ssl up

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    image: ${DOCKER_IMAGE}
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-False}
      - DB_ENGINE=django.db.backends.postgresql
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=5432
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - ENABLE_HTTPS=${ENABLE_HTTPS:-True}
      - SSL_REDIRECT=${SSL_REDIRECT:-True}
      - SECURE_COOKIES=${SECURE_COOKIES:-True}
      - HSTS_SECONDS=${HSTS_SECONDS:-31536000}
    volumes:
      - media_data:/app/media
      - logs_data:/app/logs
      - staticfiles_data:/app/staticfiles
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python /app/simple_healthcheck.py || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:1.25-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - staticfiles_data:/app/staticfiles:ro
      - media_data:/app/media:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # SSL certificate management - supports both bind mounts and named volumes
      - type: ${SSL_VOLUME_TYPE:-volume}
        source: ${SSL_CERTIFICATES_PATH:-ssl_certificates}
        target: /etc/letsencrypt
        read_only: true
      # ACME challenge webroot for certificate validation
      - type: ${ACME_VOLUME_TYPE:-volume}
        source: ${ACME_CHALLENGE_PATH:-acme_challenge}
        target: /var/www/certbot
        read_only: true
    depends_on:
      web:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nginx -t && (wget --no-verbose --tries=1 --timeout=5 --spider http://localhost/healthz/ || wget --no-verbose --tries=1 --timeout=5 --spider --no-check-certificate https://localhost/healthz/)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  certbot:
    image: certbot/certbot:latest
    profiles: ["ssl"]
    volumes:
      # SSL certificates storage - persistent across container restarts
      - type: ${SSL_VOLUME_TYPE:-volume}
        source: ${SSL_CERTIFICATES_PATH:-ssl_certificates}
        target: /etc/letsencrypt
      # ACME challenge webroot - shared with nginx for validation
      - type: ${ACME_VOLUME_TYPE:-volume}
        source: ${ACME_CHALLENGE_PATH:-acme_challenge}
        target: /var/www/certbot
    environment:
      - SSL_EMAIL=${SSL_EMAIL:-admin@example.com}
      - CERTBOT_STAGING=${CERTBOT_STAGING:-false}
      - DOMAINS=${DOMAINS:-}
    command: >
      sh -c "
        echo 'Starting certificate renewal daemon...';
        echo 'SSL Email: ${SSL_EMAIL}';
        echo 'Staging mode: ${CERTBOT_STAGING}';
        echo 'Domains: ${DOMAINS}';
        
        # Ensure webroot directory exists
        mkdir -p /var/www/certbot;
        
        trap 'echo Stopping certificate renewal daemon; exit 0' TERM INT;
        while true; do
          echo 'Checking for certificate renewal...';
          certbot renew \
            --webroot \
            --webroot-path=/var/www/certbot \
            --quiet \
            --no-random-sleep-on-renew \
            --deploy-hook 'echo Certificate renewed successfully' || echo 'Certificate renewal check completed';
          echo 'Next renewal check in 12 hours...';
          sleep 43200 &
          wait $$!;
        done;
      "
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  media_data:
    driver: local
  logs_data:
    driver: local
  staticfiles_data:
    driver: local
  ssl_certificates:
    driver: local
  acme_challenge:
    driver: local