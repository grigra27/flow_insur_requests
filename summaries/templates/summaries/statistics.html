{% extends 'base.html' %}
{% load summary_extras %}

{% block title %}Статистика по сводам - {{ block.super }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-graph-up"></i> Статистика по сводам</h1>
    <a href="{% url 'summaries:summary_list' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> К сводам
    </a>
</div>

<!-- Общая статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">
                    <i class="bi bi-collection"></i>
                </h5>
                <h3 class="text-primary">{{ stats.total_summaries }}</h3>
                <p class="card-text">Всего сводов</p>
                <small class="text-muted">+{{ stats.summaries_last_month }} за месяц</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">
                    <i class="bi bi-file-earmark-text"></i>
                </h5>
                <h3 class="text-success">{{ stats.total_offers }}</h3>
                <p class="card-text">Всего предложений</p>
                <small class="text-muted">+{{ stats.offers_last_month }} за месяц</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    <i class="bi bi-calculator"></i>
                </h5>
                <h3 class="text-info">{{ stats.avg_offers_per_summary|floatformat:1 }}</h3>
                <p class="card-text">Среднее предложений на свод</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    <i class="bi bi-hourglass-split"></i>
                </h5>
                <h3 class="text-warning">{{ stats.collecting }}</h3>
                <p class="card-text">В процессе сбора</p>
            </div>
        </div>
    </div>
</div>

<!-- Статистика по статусам, годам и условиям оплаты -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Статусы сводов</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-1">
                    <span>Сбор предложений:</span>
                    <span class="badge bg-warning">{{ stats.collecting }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Готов к отправке:</span>
                    <span class="badge bg-info">{{ stats.ready }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Отправлен:</span>
                    <span class="badge bg-primary">{{ stats.sent }}</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span>Акцепт:</span>
                    <span class="badge bg-success">{{ stats.completed_accepted }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Не будет:</span>
                    <span class="badge bg-secondary">{{ stats.completed_rejected }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Статистика по годам страхования -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-range"></i> По годам страхования</h5>
            </div>
            <div class="card-body">
                {% for year in year_stats %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ year.insurance_year }} год:</span>
                    <div>
                        <span class="badge bg-primary me-2">{{ year.count }} предл.</span>
                        <small class="text-muted">
                            ср. {{ year.avg_premium|floatformat:0|default:"—" }} ₽
                        </small>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">Нет данных</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Своды по месяцам -->
    {% if monthly_summaries_stats %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar3"></i> Своды по месяцам</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% for month_key, month_data in monthly_summaries_stats.items %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ month_data.display }}</span>
                    <span class="badge bg-info">{{ month_data.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Статистика по страховым компаниям -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-trophy"></i> Страховые компании (по предоставленным предложениям)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Компания</th>
                                <th class="text-center">Представленность, %</th>
                                <th class="text-center">В сводах, шт.</th>
                                <th class="text-center">Из них: КАСКО</th>
                                <th class="text-center">Из них: Спецтехника</th>
                                <th class="text-center">Из них: Имущество</th>
                                <th class="text-center">Из них: Другое</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for company_name, company_data in company_stats_detailed.items %}
                            <tr>
                                <td>
                                    <strong>{{ company_name }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if company_totals.total > 0 %}
                                        <span class="badge bg-secondary">{% widthratio company_data.total company_totals.total 100 %}%</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary fs-6">{{ company_data.total }}</span>
                                </td>
                                <td class="text-center">
                                    {% if company_data.types.КАСКО %}
                                        {{ company_data.types.КАСКО }}
                                        <small class="text-muted ms-1">({% widthratio company_data.types.КАСКО company_data.total 100 %}%)</small>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% with spec_count=company_data.types|get_item:"страхование спецтехники" %}
                                        {% if spec_count %}
                                            {{ spec_count }}
                                            <small class="text-muted ms-1">({% widthratio spec_count company_data.total 100 %}%)</small>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-center">
                                    {% with property_count=company_data.types|get_item:"страхование имущества" %}
                                        {% if property_count %}
                                            {{ property_count }}
                                            <small class="text-muted ms-1">({% widthratio property_count company_data.total 100 %}%)</small>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-center">
                                    {% if company_data.types.другое %}
                                        {{ company_data.types.другое }}
                                        <small class="text-muted ms-1">({% widthratio company_data.types.другое company_data.total 100 %}%)</small>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    Нет данных о предложениях
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% if company_totals %}
                        <tfoot class="table-light">
                            <tr>
                                <td><strong>Итого (кол. всех сводов)</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">100%</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary fs-6">{{ company_totals.total }}</span>
                                </td>
                                <td class="text-center">
                                    <strong>{{ company_totals.kasko }}</strong>
                                    {% if company_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio company_totals.kasko company_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ company_totals.spec }}</strong>
                                    {% if company_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio company_totals.spec company_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ company_totals.property }}</strong>
                                    {% if company_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio company_totals.property company_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ company_totals.other }}</strong>
                                    {% if company_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio company_totals.other company_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Статистика по филиалам -->
{% if branch_stats_detailed %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> По филиалам</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Филиал</th>
                                <th class="text-center">Доля, %</th>
                                <th class="text-center">Всего, шт.</th>
                                <th class="text-center">Из них: КАСКО</th>
                                <th class="text-center">Из них: Спецтехника</th>
                                <th class="text-center">Из них: Имущество</th>
                                <th class="text-center">Из них: Другое</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for branch_name, branch_data in branch_stats_detailed.items %}
                            <tr>
                                <td>
                                    <strong>{{ branch_name }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if branch_totals.total > 0 %}
                                        <span class="badge bg-secondary">{% widthratio branch_data.total branch_totals.total 100 %}%</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary fs-6">{{ branch_data.total }}</span>
                                </td>
                                <td class="text-center">
                                    {% if branch_data.types.КАСКО %}
                                        {{ branch_data.types.КАСКО }}
                                        <small class="text-muted ms-1">({% widthratio branch_data.types.КАСКО branch_data.total 100 %}%)</small>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% with spec_count=branch_data.types|get_item:"страхование спецтехники" %}
                                        {% if spec_count %}
                                            {{ spec_count }}
                                            <small class="text-muted ms-1">({% widthratio spec_count branch_data.total 100 %}%)</small>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-center">
                                    {% with property_count=branch_data.types|get_item:"страхование имущества" %}
                                        {% if property_count %}
                                            {{ property_count }}
                                            <small class="text-muted ms-1">({% widthratio property_count branch_data.total 100 %}%)</small>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-center">
                                    {% if branch_data.types.другое %}
                                        {{ branch_data.types.другое }}
                                        <small class="text-muted ms-1">({% widthratio branch_data.types.другое branch_data.total 100 %}%)</small>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    Нет данных о филиалах
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        {% if branch_totals %}
                        <tfoot class="table-light">
                            <tr>
                                <td><strong>Итого</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">100%</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary fs-6">{{ branch_totals.total }}</span>
                                </td>
                                <td class="text-center">
                                    <strong>{{ branch_totals.kasko }}</strong>
                                    {% if branch_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio branch_totals.kasko branch_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ branch_totals.spec }}</strong>
                                    {% if branch_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio branch_totals.spec branch_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ branch_totals.property }}</strong>
                                    {% if branch_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio branch_totals.property branch_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ branch_totals.other }}</strong>
                                    {% if branch_totals.total > 0 %}
                                        <small class="text-muted ms-1">({% widthratio branch_totals.other branch_totals.total 100 %}%)</small>
                                    {% endif %}
                                </td>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Статистика по менеджерам -->
{% if manager_stats %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> По менеджерам Онлайна
                    <i class="bi bi-info-circle text-muted ms-2" 
                       style="cursor: help; font-size: 0.9rem;"
                       data-bs-toggle="tooltip" 
                       data-bs-placement="right"
                       data-bs-html="true"
                       title="<strong>Логика распределения:</strong><br>
                              <strong>Сергеева:</strong> все сделки из Санкт-Петербурга<br>
                              <strong>Дроздова:</strong> пролонгации (кроме СПб) + новые сделки из Пскова, Москвы, Краснодара<br>
                              <strong>Лазарева:</strong> все остальные новые сделки">
                    </i>
                </h5>
            </div>
            <div class="card-body">
                <!-- Общая статистика по менеджерам -->
                <div class="row mb-4">
                    {% for manager, data in manager_stats.items %}
                    <div class="col-md-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title text-center mb-3">{{ manager }}</h5>
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <h4 class="text-primary mb-0">{{ data.count }}</h4>
                                        <small class="text-muted">сводов</small>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <h4 class="text-info mb-0">{{ data.offers_count }}</h4>
                                        <small class="text-muted">предложений</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-success mb-0">{{ data.accepted }}</h4>
                                        <small class="text-muted">акцептов</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-secondary mb-0">{{ data.rejected }}</h4>
                                        <small class="text-muted">не будет</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Разбивка по месяцам -->
                {% if manager_monthly_stats %}
                <hr>
                <h6 class="mb-3"><i class="bi bi-calendar3"></i> Разбивка по месяцам</h6>
                <div class="row">
                    {% for manager, months in manager_monthly_stats.items %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong>{{ manager }}</strong>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <tbody>
                                            {% for month_key, month_data in months.items %}
                                            <tr>
                                                <td>{{ month_data.display }}</td>
                                                <td class="text-end">
                                                    <span class="badge bg-primary">{{ month_data.count }}</span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Статистика по пользователям Django -->
{% if user_stats %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-check"></i> По пользователям Django
                    <i class="bi bi-info-circle text-muted ms-2" 
                       style="cursor: help; font-size: 0.9rem;"
                       data-bs-toggle="tooltip" 
                       data-bs-placement="right"
                       data-bs-html="true"
                       title="<strong>Статистика по пользователям:</strong><br>
                              Показывает данные в разбивке по пользователям Django,<br>
                              которые загружали заявки или создавали своды.<br>
                              Включает те же метрики: своды, предложения, акцепты, отказы.">
                    </i>
                </h5>
            </div>
            <div class="card-body">
                <!-- Общая статистика по пользователям -->
                <div class="row mb-4">
                    {% for user_display, data in user_stats.items %}
                    <div class="col-md-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title text-center mb-3">{{ user_display }}</h5>
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <h4 class="text-primary mb-0">{{ data.count }}</h4>
                                        <small class="text-muted">сводов</small>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <h4 class="text-info mb-0">{{ data.offers_count }}</h4>
                                        <small class="text-muted">предложений</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-success mb-0">{{ data.accepted }}</h4>
                                        <small class="text-muted">акцептов</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-secondary mb-0">{{ data.rejected }}</h4>
                                        <small class="text-muted">не будет</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Разбивка по месяцам -->
                {% if user_monthly_stats %}
                <hr>
                <h6 class="mb-3"><i class="bi bi-calendar3"></i> Разбивка по месяцам</h6>
                <div class="row">
                    {% for user_display, months in user_monthly_stats.items %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong>{{ user_display }}</strong>
                            </div>
                            <div class="card-body p-2">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <tbody>
                                            {% for month_key, month_data in months.items %}
                                            <tr>
                                                <td>{{ month_data.display }}</td>
                                                <td class="text-end">
                                                    <span class="badge bg-primary">{{ month_data.count }}</span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4">
    <small class="text-muted">
        <i class="bi bi-info-circle"></i>
        Статистика обновляется в реальном времени и включает только действительные предложения.
    </small>
</div>

<script>
// Инициализация tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

{% endblock %}