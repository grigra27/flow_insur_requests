{% extends 'base.html' %}
{% load tz %}
{% load summary_extras %}

{% block title %}–°–≤–æ–¥ –∫ {{ summary.request.get_display_name }} - {{ block.super }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-collection"></i> –°–≤–æ–¥ –∫ {{ summary.request.get_display_name }}</h1>
    <div>
        {% if summary.status == 'collecting' %}
            <a href="{% url 'summaries:add_offer' summary.pk %}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
            </a>
        {% endif %}
        {% if summary.status == 'ready' %}
            <button class="btn btn-primary" onclick="sendToClient({{ summary.id }})">
                <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ê–ª—å—è–Ω—Å
            </button>
        {% endif %}
        <a href="{% url 'summaries:summary_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h5>
                <span class="badge bg-{{ summary.status|status_color }} fs-6">
                    {{ summary.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">–ö–ª–∏–µ–Ω—Ç:</dt>
                            <dd class="col-sm-7">{{ summary.request.client_name }}</dd>
                            
                            <dt class="col-sm-5">–ò–ù–ù:</dt>
                            <dd class="col-sm-7">{{ summary.request.inn }}</dd>
                            
                            <dt class="col-sm-5">–§–∏–ª–∏–∞–ª:</dt>
                            <dd class="col-sm-7">{{ summary.branch|format_branch }}</dd>
                            
                            <dt class="col-sm-5">–¢–∏–ø —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è:</dt>
                            <dd class="col-sm-7">{{ summary.request.insurance_type }}</dd>
                            
                            <dt class="col-sm-5">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–¥–º–µ—Ç–µ –ª–∏–∑–∏–Ω–≥–∞:</dt>
                            <dd class="col-sm-7">{{ summary.request.vehicle_info|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-5">–ó–∞—è–≤–∫–∞:</dt>
                            <dd class="col-sm-7">
                                <a href="{% url 'insurance_requests:request_detail' summary.request.pk %}">{{ summary.request.get_display_name }}</a>
                            </dd>
                            
                            <dt class="col-sm-5">–°–æ–∑–¥–∞–Ω:</dt>
                            <dd class="col-sm-7">{% timezone "Europe/Moscow" %}{{ summary.created_at|date:"d.m.Y H:i" }}{% endtimezone %} (–ú–°–ö)</dd>
                            
                            {% if summary.sent_to_client_at %}
                                <dt class="col-sm-5">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω:</dt>
                                <dd class="col-sm-7">{% timezone "Europe/Moscow" %}{{ summary.sent_to_client_at|date:"d.m.Y H:i" }}{% endtimezone %} (–ú–°–ö)</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤—â–∏–∫–æ–≤ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å—Ç—Ä–∞—Ö–æ–≤—â–∏–∫–æ–≤ ({{ sorted_companies|length }})</h5>
                {% if summary.status == 'collecting' %}
                    <a href="{% url 'summaries:add_offer' summary.pk %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if offers %}
                    <!-- Company-based grouping -->
                    {% for company_name in sorted_companies %}
                        {% with company_offers=companies_with_offers|lookup:company_name %}
                            <div class="company-block mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="bi bi-building"></i> {{ company_name }}
                                    </h5>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="custom-table-header">
                                            <tr>
                                                <th style="width: 10%;">–ì–æ–¥</th>
                                                <th style="width: 15%;">–°—Ç—Ä–∞—Ö–æ–≤–∞—è —Å—É–º–º–∞</th>
                                                <th style="width: 12%;">–§—Ä–∞–Ω—à–∏–∑–∞-1</th>
                                                <th style="width: 15%;">–ü—Ä–µ–º–∏—è-1</th>
                                                <th style="width: 12%;">–§—Ä–∞–Ω—à–∏–∑–∞-2</th>
                                                <th style="width: 15%;">–ü—Ä–µ–º–∏—è-2</th>
                                                <th style="width: 21%;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for offer in company_offers %}
                                                <tr>
                                                    <td data-label="–ì–æ–¥">
                                                        <strong>{{ offer.get_insurance_year_display }}</strong>
                                                    </td>
                                                    <td data-label="–°—Ç—Ä–∞—Ö–æ–≤–∞—è —Å—É–º–º–∞">
                                                        <strong>{{ offer.insurance_sum|format_currency_with_spaces }}</strong>
                                                    </td>
                                                    <td data-label="–§—Ä–∞–Ω—à–∏–∑–∞-1">
                                                        <span class="text-primary">{{ offer.franchise_1|format_currency_with_spaces }}</span>
                                                    </td>
                                                    <td data-label="–ü—Ä–µ–º–∏—è-1">
                                                        <strong class="text-success">{{ offer.premium_with_franchise_1|format_currency_with_spaces }}</strong>
                                                        {% if offer.installment_variant_1 and offer.payments_per_year_variant_1 > 1 %}
                                                            <br><span class="badge bg-success" style="font-size: 0.65em;">
                                                                <i class="bi bi-credit-card"></i> {{ offer.payments_per_year_variant_1 }} –ø–ª–∞—Ç–µ–∂{{ offer.payments_per_year_variant_1|pluralize:"–µ–π,–∞,–µ–π" }}/–≥–æ–¥
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td data-label="–§—Ä–∞–Ω—à–∏–∑–∞-2">
                                                        {% if offer.franchise_2 %}
                                                            <span class="text-warning">{{ offer.franchise_2|format_currency_with_spaces }}</span>
                                                        {% else %}
                                                            <span class="text-muted">‚Äî</span>
                                                        {% endif %}
                                                    </td>
                                                    <td data-label="–ü—Ä–µ–º–∏—è-2">
                                                        {% if offer.premium_with_franchise_2 %}
                                                            <strong class="text-info">{{ offer.premium_with_franchise_2|format_currency_with_spaces }}</strong>
                                                            {% if offer.installment_variant_2 and offer.payments_per_year_variant_2 > 1 %}
                                                                <br><span class="badge bg-info" style="font-size: 0.65em;">
                                                                    <i class="bi bi-credit-card"></i> {{ offer.payments_per_year_variant_2 }} –ø–ª–∞—Ç–µ–∂{{ offer.payments_per_year_variant_2|pluralize:"–µ–π,–∞,–µ–π" }}/–≥–æ–¥
                                                                </span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">‚Äî</span>
                                                        {% endif %}
                                                    </td>
                                                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'summaries:edit_offer' offer.pk %}" 
                                                               class="btn btn-outline-primary btn-sm" 
                                                               title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <button class="btn btn-outline-danger btn-sm" 
                                                                    onclick="deleteOffer({{ offer.id }})"
                                                                    title="–£–¥–∞–ª–∏—Ç—å">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% if offer.notes %}
                                                    <tr>
                                                        <td colspan="7">
                                                            <small class="text-muted">
                                                                <i class="bi bi-chat-text"></i> {{ offer.notes }}
                                                            </small>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                            
                                            <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É "–ò—Ç–æ–≥–æ" –¥–ª—è –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
                                            {% with company_data=company_totals|lookup:company_name %}
                                                {% if company_data.is_multiyear %}
                                                    <tr class="table-info company-total-row">
                                                        <td data-label="–ì–æ–¥">
                                                            <strong><!--i class="bi bi-calculator"></i--> –ò—Ç–æ–≥–æ</strong>
                                                        </td>
                                                        <td data-label="–°—Ç—Ä–∞—Ö–æ–≤–∞—è —Å—É–º–º–∞">
                                                            <span class="text-muted">‚Äî</span>
                                                        </td>
                                                        <td data-label="–§—Ä–∞–Ω—à–∏–∑–∞-1">
                                                            <span class="text-muted">‚Äî</span>
                                                        </td>
                                                        <td data-label="–ü—Ä–µ–º–∏—è-1">
                                                            <strong class="text-success fs-6">{{ company_data.total_premium_1|format_currency_with_spaces }}</strong>
                                                        </td>
                                                        <td data-label="–§—Ä–∞–Ω—à–∏–∑–∞-2">
                                                            <span class="text-muted">‚Äî</span>
                                                        </td>
                                                        <td data-label="–ü—Ä–µ–º–∏—è-2">
                                                            {% if company_data.total_premium_2 > 0 %}
                                                                <strong class="text-info fs-6">{{ company_data.total_premium_2|format_currency_with_spaces }}</strong>
                                                            {% else %}
                                                                <span class="text-muted">‚Äî</span>
                                                            {% endif %}
                                                        </td>
                                                        <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                                                            <span class="text-muted">‚Äî</span>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endwith %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <h5 class="mt-3">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h5>
                        <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —Å—Ç—Ä–∞—Ö–æ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π</p>
                        <a href="{% url 'summaries:add_offer' summary.pk %}" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
            </div>
            <div class="card-body">
                <dl class="row">
                    {% if sorted_companies %}
                        <dt class="col-6">–ö–æ–º–ø–∞–Ω–∏–π:</dt>
                        <dd class="col-6">
                            <span class="badge bg-primary">{{ sorted_companies|length }}</span>
                        </dd>
                        
                        <dt class="col-6">–ü–æ –∫–æ–º–ø–∞–Ω–∏—è–º:</dt>
                        <dd class="col-6">
                            {% for company_name in sorted_companies %}
                                <span class="badge bg-secondary me-1 mb-1">{{ company_name }}</span>
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </dd>
                    {% endif %}
                </dl>
                
                {% if summary.status == 'ready' %}
                    <div class="d-grid">
                        <button class="btn btn-success" onclick="generateSummaryFile({{ summary.id }})">
                            <i class="bi bi-file-earmark-excel"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Excel
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-gear"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</label>
                    <div>
                        <span id="current-status-badge" class="badge bg-{{ summary.status|status_color }} fs-6">
                            {{ summary.get_status_display }}
                        </span>
                    </div>
                </div>
                
                <!-- –§–æ—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
                <div class="mb-3">
                    <label for="status-select" class="form-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                    <div class="input-group">
                        <select id="status-select" class="form-select">
                            <option value="collecting" {% if summary.status == 'collecting' %}selected{% endif %}>–°–±–æ—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</option>
                            <option value="ready" {% if summary.status == 'ready' %}selected{% endif %}>–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</option>
                            <option value="sent" {% if summary.status == 'sent' %}selected{% endif %}>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ê–ª—å—è–Ω—Å</option>
                            <option value="completed_accepted" {% if summary.status == 'completed_accepted' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω: –∞–∫—Ü–µ–ø—Ç/—Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–µ</option>
                            <option value="completed_rejected" {% if summary.status == 'completed_rejected' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω: –Ω–µ –±—É–¥–µ—Ç</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="changeStatus({{ summary.id }})">
                            <i class="bi bi-check-lg"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                    </div>
                    <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"</div>
                </div>
                

                
                {% if summary.status == 'sent' %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        –°–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ê–ª—å—è–Ω—Å {% timezone "Europe/Moscow" %}{{ summary.sent_to_client_at|date:"d.m.Y –≤ H:i" }}{% endtimezone %} (–ú–°–ö)
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.company-block {
    border: 1px solid #f0ebe3;
    border-radius: 8px;
    padding: 1.25rem;
    background: linear-gradient(145deg, #fafaf8 0%, #f5f3f0 100%);
    margin-bottom: 1.5rem;
}

.company-block h5 {
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0.5rem;
}

.company-block .table {
    background-color: #fefefe;
    margin-bottom: 0;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #f0ebe3;
}

.custom-table-header th {
    font-size: 0.875rem;
    font-weight: 600;
    color: #4a4a4a;
    border-top: none;
    background-color: #f4f4f2;
    border-bottom: 1px solid #e0e0de;
    position: relative;
    letter-spacing: 0.3px;
}

.custom-table-header th:first-child {
    border-top-left-radius: 6px;
}

.custom-table-header th:last-child {
    border-top-right-radius: 6px;
}

.company-block .table th {
    font-size: 0.875rem;
    font-weight: 600;
    color: #5a5a5a;
    border-top: none;
}

.company-block .table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

.company-block .table tbody tr {
    background-color: #fcfcfa;
}

.company-block .table tbody tr:nth-child(even) {
    background-color: #f9f8f5;
}

/* Responsive design for mobile */
@media (max-width: 768px) {
    .company-block .table-responsive {
        font-size: 0.8rem;
    }
    
    .company-block .table th,
    .company-block .table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.75rem;
    }
    
    .company-block .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.7rem;
    }
    
    .company-block .badge {
        font-size: 0.6em;
    }
}

@media (max-width: 576px) {
    .company-block {
        padding: 0.5rem;
    }
    
    .company-block h5 {
        font-size: 1rem;
    }
    
    /* Stack table content vertically on very small screens */
    .company-block .table-responsive {
        border: none;
    }
    
    .company-block .table,
    .company-block .table thead,
    .company-block .table tbody,
    .company-block .table th,
    .company-block .table td,
    .company-block .table tr {
        display: block;
    }
    
    .company-block .table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    
    .company-block .table tr {
        border: 1px solid #ccc;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        background-color: white;
    }
    
    .company-block .table td {
        border: none;
        position: relative;
        padding-left: 50% !important;
        text-align: left;
        white-space: nowrap;
    }
    
    .company-block .table td:before {
        content: attr(data-label) ": ";
        position: absolute;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
        color: #495057;
    }
}

/* Color coding for franchise variants */
.text-primary { color: #0d6efd !important; }
.text-warning { color: #fd7e14 !important; }
.text-success { color: #198754 !important; }
.text-info { color: #0dcaf0 !important; }

/* Styles for company total rows */
.company-total-row {
    background-color: #e3f2fd !important;
    border-top: 2px solid #2196f3 !important;
    font-weight: 600;
}

.company-total-row td {
    padding: 0.75rem 0.5rem !important;
    vertical-align: middle;
    border-top: 2px solid #2196f3 !important;
}

.company-total-row strong {
    font-size: 0.95rem;
    letter-spacing: 0.3px;
}

.company-total-row .bi-calculator {
    color: #1976d2;
    margin-right: 0.25rem;
}

/* Hover effect for total rows */
.company-total-row:hover {
    background-color: #bbdefb !important;
    transition: background-color 0.2s ease;
}

/* Mobile responsive styles for total rows */
@media (max-width: 576px) {
    .company-total-row td:before {
        font-weight: bold;
        color: #1976d2;
    }
    
    .company-total-row {
        background-color: #e3f2fd !important;
        border: 2px solid #2196f3 !important;
        border-radius: 5px;
        margin-top: 10px;
    }
}

/* Loading button styles */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: inherit;
}

/* Spinner animation for loading states */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.1em;
}

@keyframes spinner-border {
    to {
        transform: rotate(360deg);
    }
}

.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: -0.125em;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

/* Enhanced notification styles */
.alert.position-fixed {
    animation: slideInRight 0.3s ease-out;
    border-left: 4px solid;
}

.alert-success.position-fixed {
    border-left-color: #198754;
}

.alert-danger.position-fixed {
    border-left-color: #dc3545;
}

.alert-info.position-fixed {
    border-left-color: #0dcaf0;
}

.alert-warning.position-fixed {
    border-left-color: #ffc107;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
function formatCurrency(amount) {
    if (!amount || isNaN(amount)) return '‚Äî';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatNumber(number) {
    if (!number || isNaN(number)) return '‚Äî';
    return new Intl.NumberFormat('ru-RU').format(number);
}

function formatPaymentsInfo(paymentsPerYear, premium) {
    if (!paymentsPerYear || paymentsPerYear <= 1) return '';
    
    const paymentText = paymentsPerYear === 2 ? '–ø–ª–∞—Ç–µ–∂–∞' : 
                       paymentsPerYear <= 4 ? '–ø–ª–∞—Ç–µ–∂–∞' : '–ø–ª–∞—Ç–µ–∂–µ–π';
    
    return `${paymentsPerYear} ${paymentText}/–≥–æ–¥`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function updateOfferDisplay() {
    const offerRows = document.querySelectorAll('tbody tr');
    
    offerRows.forEach(row => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
        const currencyFields = row.querySelectorAll('[data-currency]');
        currencyFields.forEach(field => {
            const amount = parseFloat(field.dataset.currency);
            if (!isNaN(amount)) {
                field.textContent = formatCurrency(amount);
            }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ
        const paymentsInfo = row.querySelector('.payments-info');
        if (paymentsInfo) {
            const paymentsPerYear = parseInt(paymentsInfo.dataset.payments);
            const premium = parseFloat(paymentsInfo.dataset.premium);
            
            if (paymentsPerYear > 1 && premium) {
                paymentsInfo.innerHTML = `<small class="text-muted">${formatPaymentsInfo(paymentsPerYear, premium)}</small>`;
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫ —Ç–∞–±–ª–∏—Ü–∞–º
function enhanceTableInteractivity() {
    const offerRows = document.querySelectorAll('tbody tr');
    
    offerRows.forEach(row => {
        // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.style.transition = 'background-color 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π
        row.addEventListener('click', function(e) {
            // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º
            if (e.target.closest('button') || e.target.closest('a')) return;
            
            const notesRow = this.nextElementSibling;
            if (notesRow && notesRow.querySelector('td[colspan]')) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–π
                if (notesRow.style.display === 'none') {
                    notesRow.style.display = '';
                    this.classList.add('table-info');
                } else {
                    notesRow.style.display = 'none';
                    this.classList.remove('table-info');
                }
            }
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞
function checkBrowserCompatibility() {
    const features = {
        fetch: typeof fetch !== 'undefined',
        intl: typeof Intl !== 'undefined',
        arrow: (() => { try { eval('() => {}'); return true; } catch(e) { return false; } })(),
        const: (() => { try { eval('const x = 1'); return true; } catch(e) { return false; } })()
    };
    
    const unsupported = Object.keys(features).filter(key => !features[key]);
    
    if (unsupported.length > 0) {
        console.warn('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ:', unsupported);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        if (unsupported.includes('fetch') || unsupported.includes('arrow')) {
            const warning = document.createElement('div');
            warning.className = 'alert alert-warning alert-dismissible fade show';
            warning.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í–∞—à –±—Ä–∞—É–∑–µ—Ä —É—Å—Ç–∞—Ä–µ–ª. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
                –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid, .container, body').prepend(warning);
        }
    }
    
    return features;
}

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ç—å—é
function handleNetworkError(error) {
    console.error('Network error:', error);
    
    if (!navigator.onLine) {
        showErrorMessage('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        return;
    }
    
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
        showErrorMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }
    
    showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
function checkDownloadSupport() {
    const features = {
        blob: typeof Blob !== 'undefined',
        url: typeof URL !== 'undefined' && typeof URL.createObjectURL === 'function',
        download: 'download' in document.createElement('a')
    };
    
    const unsupported = Object.keys(features).filter(key => !features[key]);
    
    if (unsupported.length > 0) {
        console.warn('Browser missing download features:', unsupported);
        showWarningMessage('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä.', 8000);
        return false;
    }
    
    return true;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
function safeDownloadFile(blob, filename) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
        if (!checkDownloadSupport()) {
            throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤');
        }
        
        // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è blob
        const url = window.URL.createObjectURL(blob);
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const downloadLink = document.createElement('a');
        downloadLink.style.display = 'none';
        downloadLink.href = url;
        downloadLink.download = filename;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
        downloadLink.addEventListener('click', () => {
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                if (downloadLink.parentNode) {
                    downloadLink.parentNode.removeChild(downloadLink);
                }
            }, 100);
        });
        
        // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
        document.body.appendChild(downloadLink);
        downloadLink.click();
        
        return true;
    } catch (error) {
        console.error('Error in safeDownloadFile:', error);
        showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
function safeAjaxRequest(url, options = {}) {
    const defaultOptions = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        credentials: 'same-origin',
    };
    
    const mergedOptions = { ...defaultOptions, ...options };
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ —ç—Ç–æ POST –∑–∞–ø—Ä–æ—Å
    if (mergedOptions.method === 'POST' && !mergedOptions.body?.has?.('csrfmiddlewaretoken')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            if (mergedOptions.body instanceof FormData) {
                mergedOptions.body.append('csrfmiddlewaretoken', csrfToken);
            } else {
                mergedOptions.headers['X-CSRFToken'] = csrfToken;
            }
        }
    }
    
    return fetch(url, mergedOptions)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .catch(error => {
            handleNetworkError(error);
            throw error;
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function checkPageState() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞ –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    const pageLoadTime = window.pageLoadTime || Date.now();
    const currentTime = Date.now();
    const pageAge = currentTime - pageLoadTime;
    
    // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ä—à–µ 30 –º–∏–Ω—É—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
    if (pageAge > 30 * 60 * 1000) {
        showWarningMessage('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.', 10000);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info', duration = 3000) {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞
    const existingAlerts = document.querySelectorAll(`.alert-${type}.position-fixed`);
    existingAlerts.forEach(alert => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    });
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);';
    
    const icons = {
        'success': 'bi-check-circle',
        'danger': 'bi-exclamation-triangle',
        'warning': 'bi-exclamation-triangle',
        'info': 'bi-info-circle'
    };
    
    const icon = icons[type] || icons['info'];
    
    alertDiv.innerHTML = `
        <i class="bi ${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    const timeoutId = setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.transition = 'all 0.3s ease-out';
            alertDiv.style.transform = 'translateX(100%)';
            alertDiv.style.opacity = '0';
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 300);
        }
    }, duration);
    
    // –ü–æ–∑–≤–æ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
    const closeButton = alertDiv.querySelector('.btn-close');
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            clearTimeout(timeoutId);
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        });
    }
    
    return alertDiv;
}

function showSuccessMessage(message, duration = 3000) {
    return showNotification(message, 'success', duration);
}

function showErrorMessage(message, duration = 5000) {
    return showNotification(message, 'danger', duration);
}

function showWarningMessage(message, duration = 4000) {
    return showNotification(message, 'warning', duration);
}

function showInfoMessage(message, duration = 3000) {
    return showNotification(message, 'info', duration);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoadingIndicator(message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-indicator';
    loadingDiv.className = 'position-fixed d-flex align-items-center justify-content-center';
    loadingDiv.style.cssText = `
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
    `;
    
    loadingDiv.innerHTML = `
        <div class="bg-white p-4 rounded shadow text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div>${message}</div>
        </div>
    `;
    
    document.body.appendChild(loadingDiv);
    return loadingDiv;
}

function hideLoadingIndicator() {
    const loadingDiv = document.getElementById('loading-indicator');
    if (loadingDiv && loadingDiv.parentNode) {
        loadingDiv.parentNode.removeChild(loadingDiv);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.pageLoadTime = Date.now();
    
    checkBrowserCompatibility();
    updateOfferDisplay();
    enhanceTableInteractivity();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤ —Å–µ–ª–µ–∫—Ç–µ
    const statusSelect = document.getElementById('status-select');
    if (statusSelect) {
        const currentBadge = document.getElementById('current-status-badge');
        if (currentBadge) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∏–∑ –∫–ª–∞—Å—Å–∞ –±–µ–π–¥–∂–∞
            const badgeClasses = currentBadge.className;
            let currentStatus = 'collecting'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            if (badgeClasses.includes('bg-success')) {
                // Only 'completed_accepted' uses success color now
                currentStatus = 'completed_accepted';
            } else if (badgeClasses.includes('bg-danger')) {
                currentStatus = 'completed_rejected';
            } else if (badgeClasses.includes('bg-secondary')) {
                // Could be 'sent' or 'completed' - check text content
                const statusText = badge.textContent.trim();
                if (statusText.includes('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω') || statusText.includes('–ê–ª—å—è–Ω—Å')) {
                    currentStatus = 'sent';
                } else {
                    currentStatus = 'completed'; // fallback for old completed status
                }
            } else if (badgeClasses.includes('bg-info')) {
                currentStatus = 'ready';
            } else if (badgeClasses.includes('bg-warning')) {
                currentStatus = 'collecting';
            }
            
            statusSelect.dataset.currentStatus = currentStatus;
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–∞)
    setInterval(() => {
        if (!document.hidden) {
            updateOfferDisplay();
            checkPageState();
        }
    }, 30000);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–µ—Ç–∏
    window.addEventListener('online', () => {
        showSuccessMessage('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    });
    
    window.addEventListener('offline', () => {
        showWarningMessage('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
    });
});

function sendToClient(summaryId) {
    if (confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–¥ –≤ –ê–ª—å—è–Ω—Å? –°—Ç–∞—Ç—É—Å —Å–≤–æ–¥–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.')) {
        const button = event.target;
        const originalContent = button.innerHTML;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>–û—Ç–ø—Ä–∞–≤–∫–∞...';
        button.disabled = true;
        
        fetch(`/summaries/${summaryId}/send-to-client/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showSuccessMessage(data.message);
                // –ù–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —Ç–∞–∫ –∫–∞–∫ —Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
            } else {
                showErrorMessage('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–≤–æ–¥–∞');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
}

function deleteOffer(offerId) {
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –∏–∑ DOM
    const offerRow = event.target.closest('tr');
    const yearCell = offerRow.querySelector('td[data-label="–ì–æ–¥"] strong');
    const companyBlock = offerRow.closest('.company-block');
    const companyTitle = companyBlock.querySelector('h5').textContent.trim().replace('üè¢', '').trim(); // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏, —É–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥–æ–¥ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1 –≥–æ–¥" -> "1")
    const yearText = yearCell ? yearCell.textContent.trim() : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ–¥';
    
    // –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const confirmMessage = `–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç "${companyTitle}" (${yearText})?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
    
    if (confirm(confirmMessage)) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const deleteButton = event.target.closest('button');
        const originalContent = deleteButton.innerHTML;
        deleteButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        deleteButton.disabled = true;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
        offerRow.style.opacity = '0.6';
        offerRow.style.pointerEvents = 'none';
        
        fetch(`/summaries/offer/${offerId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showSuccessMessage(data.message || '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ');
                
                // –ê–Ω–∏–º–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                offerRow.style.transition = 'all 0.5s ease-out';
                offerRow.style.opacity = '0';
                offerRow.style.transform = 'translateX(-100%)';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    location.reload();
                }, 800);
            } else {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
                offerRow.style.opacity = '';
                offerRow.style.pointerEvents = '';
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                deleteButton.innerHTML = originalContent;
                deleteButton.disabled = false;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                showErrorMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('Error deleting offer:', error);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
            offerRow.style.opacity = '';
            offerRow.style.pointerEvents = '';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            deleteButton.innerHTML = originalContent;
            deleteButton.disabled = false;
            
            showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    }
}

function generateSummaryFile(summaryId) {
    // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const button = event.target;
    const originalContent = button.innerHTML;
    const originalDisabled = button.disabled;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
    if (!summaryId || isNaN(summaryId)) {
        showErrorMessage('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–≤–æ–¥–∞');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    if (!navigator.onLine) {
        showErrorMessage('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    button.innerHTML = '<i class="bi bi-hourglass-split spinner-border spinner-border-sm me-1"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...';
    button.disabled = true;
    button.classList.add('btn-loading');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
    showInfoMessage('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Excel —Ñ–∞–π–ª–∞...', 2000);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ñ–∞–π–ª–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    fetch(`/summaries/${summaryId}/generate-file/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Cache-Control': 'no-cache'
        }
    })
    .then(response => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
            // –ï—Å–ª–∏ —ç—Ç–æ JSON –æ—à–∏–±–∫–∞, –ø–∞—Ä—Å–∏–º –µ—ë
            if (response.headers.get('content-type')?.includes('application/json')) {
                return response.json().then(data => {
                    throw new Error(data.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                });
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ JSON, —Å–æ–∑–¥–∞–µ–º –æ–±—â—É—é –æ—à–∏–±–∫—É
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ Excel —Ñ–∞–π–ª
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('spreadsheet')) {
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞');
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        return response.blob().then(blob => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            if (blob.size === 0) {
                throw new Error('–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª');
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Content-Disposition
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `svod_${summaryId}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            const downloadSuccess = safeDownloadFile(blob, filename);
            
            if (downloadSuccess) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                showSuccessMessage(`Excel —Ñ–∞–π–ª "${filename}" —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω`, 4000);
                
                // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
                console.log(`Excel file generated successfully: ${filename}, size: ${blob.size} bytes`);
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        });
    })
    .catch(error => {
        console.error('Error generating summary file:', error);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
        } else if (error.message.includes('–§–∞–π–ª –º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–¥–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ')) {
            errorMessage = '–§–∞–π–ª –º–æ–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–¥–æ–≤ –≤ —Å—Ç–∞—Ç—É—Å–µ "–ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ"';
        } else if (error.message.includes('–Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö')) {
            errorMessage = '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
        } else if (error.message.includes('–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —à–∞–±–ª–æ–Ω–∞')) {
            errorMessage = '–®–∞–±–ª–æ–Ω Excel —Ñ–∞–π–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        showErrorMessage(errorMessage, 6000);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ –∫–æ–Ω—Å–æ–ª–∏
        console.error('Detailed error info:', {
            message: error.message,
            stack: error.stack,
            summaryId: summaryId,
            timestamp: new Date().toISOString()
        });
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        button.innerHTML = originalContent;
        button.disabled = originalDisabled;
        button.classList.remove('btn-loading');
    });
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º
function changeStatus(summaryId) {
    const statusSelect = document.getElementById('status-select');
    const newStatus = statusSelect.value;
    const currentBadge = document.getElementById('current-status-badge');
    
    if (!newStatus) {
        showErrorMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const currentStatus = statusSelect.dataset.currentStatus || statusSelect.querySelector('option[selected]')?.value;
    
    if (newStatus === currentStatus) {
        showInfoMessage('–°—Ç–∞—Ç—É—Å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const applyButton = event.target;
    const originalContent = applyButton.innerHTML;
    applyButton.innerHTML = '<i class="bi bi-hourglass-split"></i> –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è...';
    applyButton.disabled = true;
    statusSelect.disabled = true;
    
    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const formData = new FormData();
    formData.append('status', newStatus);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/summaries/${summaryId}/change-status/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
            updateStatusBadge(data.new_status, data.new_status_display);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç
            statusSelect.value = data.new_status;
            statusSelect.dataset.currentStatus = data.new_status;
            
            showSuccessMessage(data.message);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showErrorMessage('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error changing status:', error);
        showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    })
    .finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        applyButton.innerHTML = originalContent;
        applyButton.disabled = false;
        statusSelect.disabled = false;
    });
}

// –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function quickStatusChange(summaryId, newStatus) {
    const confirmMessages = {
        'ready': '–û—Ç–º–µ—Ç–∏—Ç—å —Å–≤–æ–¥ –∫–∞–∫ –≥–æ—Ç–æ–≤—ã–π –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ?',
        'sent': '–û—Ç–º–µ—Ç–∏—Ç—å —Å–≤–æ–¥ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤ –ê–ª—å—è–Ω—Å?',
        'completed_accepted': '–û—Ç–º–µ—Ç–∏—Ç—å —Å–≤–æ–¥ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π (–∞–∫—Ü–µ–ø—Ç/—Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–µ)?',
        'completed_rejected': '–û—Ç–º–µ—Ç–∏—Ç—å —Å–≤–æ–¥ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π (–Ω–µ –±—É–¥–µ—Ç)?'
    };
    
    const message = confirmMessages[newStatus] || '–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å?';
    
    if (confirm(message)) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = event.target;
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è...';
        button.disabled = true;
        
        // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const formData = new FormData();
        formData.append('status', newStatus);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/summaries/${summaryId}/change-status/`, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞
                updateStatusBadge(data.new_status, data.new_status_display);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç
                document.getElementById('status-select').value = data.new_status;
                showSuccessMessage(data.message);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showErrorMessage('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
}

function updateStatusBadge(status, statusDisplay) {
    const badge = document.getElementById('current-status-badge');
    if (badge) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Ü–≤–µ—Ç–æ–≤
        badge.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-secondary');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å —Ü–≤–µ—Ç–∞
        switch(status) {
            case 'completed_accepted':
                badge.classList.add('bg-success');
                break;
            case 'completed_rejected':
                badge.classList.add('bg-danger');
                break;
            case 'sent':
                badge.classList.add('bg-secondary');
                break;
            case 'ready':
                badge.classList.add('bg-info');
                break;
            case 'collecting':
                badge.classList.add('bg-warning');
                break;
            default:
                badge.classList.add('bg-secondary');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        badge.textContent = statusDisplay;
    }
}
</script>
{% endblock %}