{% extends 'base.html' %}
{% load tz %}
{% load summary_extras %}

{% block title %}Свод к {{ summary.request.get_display_name }} - {{ block.super }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-collection"></i> Свод к {{ summary.request.get_display_name }}</h1>
    <div>
        {% if summary.status == 'collecting' %}
            <a href="{% url 'summaries:add_offer' summary.pk %}" class="btn btn-success me-2">
                <i class="bi bi-plus-circle"></i> Добавить предложение вручную
            </a>
        {% endif %}

        <a href="{% url 'summaries:summary_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> К списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Информация о заявке -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Информация о заявке</h5>
                <span class="badge {{ summary.status|status_badge_class }} fs-6">
                    {{ summary.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <dl class="row">
                            <dt class="col-sm-5">Клиент:</dt>
                            <dd class="col-sm-7">{{ summary.request.client_name }}</dd>
                            
                            <dt class="col-sm-5">ИНН:</dt>
                            <dd class="col-sm-7">{{ summary.request.inn }}</dd>
                            
                            <dt class="col-sm-5">Филиал:</dt>
                            <dd class="col-sm-7">{{ summary.branch|format_branch }}</dd>
                            
                            <dt class="col-sm-5">Тип страхования:</dt>
                            <dd class="col-sm-7">{{ summary.request.insurance_type }}</dd>
                            
                            <dt class="col-sm-5">Информация о предмете лизинга:</dt>
                            <dd class="col-sm-7">{{ summary.request.vehicle_info|default:"Не указано" }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <dl class="row">
                            <dt class="col-sm-5 text-end">Заявка:</dt>
                            <dd class="col-sm-7">
                                <a href="{% url 'insurance_requests:request_detail' summary.request.pk %}">{{ summary.request.get_display_name }}</a>
                            </dd>
                            
                            <dt class="col-sm-5 text-end">Создан:</dt>
                            <dd class="col-sm-7">{% timezone "Europe/Moscow" %}{{ summary.created_at|date:"d.m.Y H:i" }}{% endtimezone %}</dd>
                            
                            {% if summary.sent_to_client_at %}
                                <dt class="col-sm-5 text-end">Отправлен:</dt>
                                <dd class="col-sm-7">{% timezone "Europe/Moscow" %}{{ summary.sent_to_client_at|date:"d.m.Y H:i" }}{% endtimezone %}</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Предложения страховщиков -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Предложения страховщиков ({{ sorted_companies|length }})</h5>
                {% if summary.status == 'collecting' %}
                    <a href="{% url 'summaries:add_offer' summary.pk %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> Добавить предложение вручную
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if offers %}
                    <!-- Company-based grouping -->
                    {% for company_name in sorted_companies %}
                        {% with company_offers=companies_with_offers|lookup:company_name %}
                            <div class="company-block mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="bi bi-building"></i> {{ company_name }}
                                    </h5>
                                </div>
                                
                                <!-- Отображение примечаний компании -->
                                {% with notes=company_notes|lookup:company_name %}
                                    {% if notes %}
                                        <div class="company-notes mb-3">
                                            <div class="alert alert-info py-2 px-3 mb-0">
                                                <i class="bi bi-info-circle me-2"></i>
                                                <strong>Примечания:</strong>
                                                {% for note in notes %}
                                                    <div class="mt-1">{{ note }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                                
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="custom-table-header">
                                            <tr>
                                                <th style="width: 10%;">Год</th>
                                                <th style="width: 19%;">СС</th>
                                                <th style="width: 13%;">Фр.-1</th>
                                                <th style="width: 16%;">СП-1</th>
                                                <th style="width: 13%;">Фр.-2</th>
                                                <th style="width: 16%;">СП-2</th>
                                                <th style="width: 13%;">Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for offer in company_offers %}
                                                <tr>
                                                    <td data-label="Год">
                                                        <strong>{{ offer.get_insurance_year_display }}</strong>
                                                    </td>
                                                    <td data-label="Страховая сумма">
                                                        <strong>{{ offer.insurance_sum|format_currency_with_spaces }}</strong>
                                                    </td>
                                                    <td data-label="Франшиза-1">
                                                        <span class="franchise-variant-1">{{ offer.franchise_1|format_currency_with_spaces }}</span>
                                                    </td>
                                                    <td data-label="Премия-1">
                                                        <strong class="franchise-variant-1">{{ offer.premium_with_franchise_1|format_currency_with_spaces }}</strong>
                                                        {% if offer.installment_variant_1 and offer.payments_per_year_variant_1 > 1 %}
                                                            <br><span class="badge bg-success" style="font-size: 0.65em;">
                                                                <i class="bi bi-credit-card"></i> {{ offer.payments_per_year_variant_1 }} платеж{{ offer.payments_per_year_variant_1|pluralize:"ей,а,ей" }}/год
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td data-label="Франшиза-2">
                                                        {% if offer.franchise_2 %}
                                                            <span class="franchise-variant-2">{{ offer.franchise_2|format_currency_with_spaces }}</span>
                                                        {% else %}
                                                            <span class="text-muted">—</span>
                                                        {% endif %}
                                                    </td>
                                                    <td data-label="Премия-2">
                                                        {% if offer.premium_with_franchise_2 %}
                                                            <strong class="franchise-variant-2">{{ offer.premium_with_franchise_2|format_currency_with_spaces }}</strong>
                                                            {% if offer.installment_variant_2 and offer.payments_per_year_variant_2 > 1 %}
                                                                <br><span class="badge bg-dark" style="font-size: 0.65em;">
                                                                    <i class="bi bi-credit-card"></i> {{ offer.payments_per_year_variant_2 }} платеж{{ offer.payments_per_year_variant_2|pluralize:"ей,а,ей" }}/год
                                                                </span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">—</span>
                                                        {% endif %}
                                                    </td>
                                                    <td data-label="Действия">
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'summaries:edit_offer' offer.pk %}" 
                                                               class="btn btn-outline-primary btn-sm" 
                                                               title="Редактировать">
                                                                <i class="bi bi-pencil"></i>
                                                            </a>
                                                            <a href="{% url 'summaries:copy_offer' offer.pk %}" 
                                                               class="btn btn-outline-success btn-sm" 
                                                               title="Копировать">
                                                                <i class="bi bi-arrow-repeat"></i>
                                                            </a>
                                                            <button class="btn btn-outline-danger btn-sm" 
                                                                    onclick="deleteOffer({{ offer.id }})"
                                                                    title="Удалить">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            
                                            <!-- Добавляем строку "Итого" для многолетних предложений -->
                                            {% with company_data=company_totals|lookup:company_name %}
                                                {% if company_data.is_multiyear %}
                                                    <tr class="company-total-row">
                                                        <td data-label="Год">
                                                            <strong><!--i class="bi bi-calculator"></i--> Итого</strong>
                                                        </td>
                                                        <td data-label="Страховая сумма">
                                                            <span class="text-muted">—</span>
                                                        </td>
                                                        <td data-label="Франшиза-1">
                                                            <span class="text-muted">—</span>
                                                        </td>
                                                        <td data-label="Премия-1">
                                                            <strong class="franchise-variant-1 fs-6">{{ company_data.total_premium_1|format_currency_with_spaces }}</strong>
                                                        </td>
                                                        <td data-label="Франшиза-2">
                                                            <span class="text-muted">—</span>
                                                        </td>
                                                        <td data-label="Премия-2">
                                                            {% if company_data.total_premium_2 > 0 %}
                                                                <strong class="franchise-variant-2 fs-6">{{ company_data.total_premium_2|format_currency_with_spaces }}</strong>
                                                            {% else %}
                                                                <span class="text-muted">—</span>
                                                            {% endif %}
                                                        </td>
                                                        <td data-label="Действия">
                                                            <span class="text-muted">—</span>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endwith %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <h5 class="mt-3">Предложений пока нет</h5>
                        <p class="text-muted">Добавьте предложения от страховых компаний</p>
                        <a href="{% url 'summaries:add_offer' summary.pk %}" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Добавить первое предложение
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Сводная информация -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Сводная информация</h6>
            </div>
            <div class="card-body">
                <dl class="row">
                    {% if sorted_companies %}
                        <dt class="col-6">Компаний:</dt>
                        <dd class="col-6">
                            <span class="badge bg-primary">{{ sorted_companies|length }}</span>
                        </dd>
                        
                        <dt class="col-6">По компаниям:</dt>
                        <dd class="col-6">
                            {% for company_name in sorted_companies %}
                                <span class="badge bg-secondary me-1 mb-1">{{ company_name }}</span>
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </dd>
                    {% endif %}
                </dl>
                
                {% if summary.status == 'ready' %}
                    <div class="d-grid">
                        <button class="btn btn-success" onclick="generateSummaryFile({{ summary.id }})">
                            <i class="bi bi-file-earmark-excel"></i> Сгенерировать Excel
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Статус и действия -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Управление статусом</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Текущий статус:</label>
                    <div>
                        <span id="current-status-badge" class="badge {{ summary.status|status_badge_class }} fs-6">
                            {{ summary.get_status_display }}
                        </span>
                    </div>
                </div>
                
                <!-- Форма изменения статуса -->
                <div class="mb-3">
                    <label for="status-select" class="form-label">Изменить статус:</label>
                    <div class="input-group">
                        <select id="status-select" class="form-select">
                            <option value="collecting" {% if summary.status == 'collecting' %}selected{% endif %}>Сбор предложений</option>
                            <option value="ready" {% if summary.status == 'ready' %}selected{% endif %}>Готов к отправке</option>
                            <option value="sent" {% if summary.status == 'sent' %}selected{% endif %}>Отправлен в Альянс</option>
                            <option value="completed_accepted" {% if summary.status == 'completed_accepted' %}selected{% endif %}>Завершен: акцепт/распоряжение</option>
                            <option value="completed_rejected" {% if summary.status == 'completed_rejected' %}selected{% endif %}>Завершен: не будет</option>
                        </select>
                        <button type="button" class="btn btn-primary" onclick="changeStatus({{ summary.id }})">
                            <i class="bi bi-check-lg"></i> Применить
                        </button>
                    </div>
                    <div class="form-text">Выберите новый статус и нажмите "Применить"</div>
                </div>
                

                
                {% if summary.status == 'sent' %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Свод отправлен в Альянс {% timezone "Europe/Moscow" %}{{ summary.sent_to_client_at|date:"d.m.Y в H:i" }}{% endtimezone %} (МСК)
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Ответы компаний -->
        {% if summary.status == 'collecting' %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-upload"></i> Ответы компаний</h6>
            </div>
            <div class="card-body">
                <form id="company-response-form" method="POST" action="{% url 'summaries:upload_multiple_company_responses' summary.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="company-response-files" class="form-label">Файлы с предложениями</label>
                        <input type="file" class="form-control" id="company-response-files" 
                               name="excel_files" accept=".xlsx" multiple required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            Выберите один или несколько Excel файлов (.xlsx) с предложениями от страховых компаний.
                            Максимум 10 файлов, размер каждого до 1MB, общий размер до 10MB.
                        </div>
                    </div>
                    
                    <!-- Список выбранных файлов -->
                    <div id="selected-files-list" class="mb-3" style="display: none;">
                        <h6 class="text-muted">Выбранные файлы:</h6>
                        <div id="files-container" class="border rounded p-2 bg-light">
                            <!-- Файлы будут добавлены через JavaScript -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Загрузить предложения
                    </button>
                </form>
                
                <!-- Индикатор загрузки -->
                <div id="upload-progress" class="mt-3" style="display: none;">
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 100%"></div>
                    </div>
                    <small class="text-muted">Обработка файлов...</small>
                </div>

                <!-- Результаты загрузки -->
                <div id="upload-results" class="mt-3" style="display: none;">
                    <!-- Сообщения будут добавлены через JavaScript -->
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Company notes styles */
.company-notes {
    margin-bottom: 1rem;
}

.company-notes .alert {
    border-left: 4px solid #e91e63;
    background-color: #fce4ec;
    border-color: #f8bbd9;
    font-size: 0.95rem;
    line-height: 1.4;
}

.company-notes .alert strong {
    color: #880e4f;
    font-weight: 600;
}

.company-notes .alert div {
    color: #880e4f;
    margin-top: 0.25rem;
    padding-left: 0.5rem;
    border-left: 2px solid #f8bbd9;
    margin-left: 0.5rem;
}

.company-notes .alert div:first-of-type {
    margin-top: 0.5rem;
}

.company-notes .alert .bi-info-circle {
    color: #e91e63;
    font-size: 1rem;
}

/* Responsive design for mobile */
@media (max-width: 768px) {
    .company-block .table-responsive {
        font-size: 0.9rem;
    }
    
    .company-block .table th,
    .company-block .table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.85rem;
    }
    
    .company-block .btn-group-sm .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.7rem;
    }
    
    .company-block .badge {
        font-size: 0.6em;
    }
    
    /* Company notes responsive styles for tablets */
    .company-notes .alert {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
    }
    
    .company-notes .alert div {
        margin-left: 0.25rem;
        padding-left: 0.25rem;
    }
    
    /* Maintain color coding visibility on tablets */
    .franchise-variant-1 {
        color: #0f5132 !important;
        font-weight: 600;
    }
    
    .franchise-variant-2 {
        color: #052c65 !important;
        font-weight: 600;
    }
}

@media (max-width: 576px) {
    .company-block {
        padding: 0.5rem;
    }
    
    .company-block h5 {
        font-size: 1rem;
    }
    
    /* Company notes responsive styles for mobile */
    .company-notes .alert {
        font-size: 0.85rem;
        padding: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .company-notes .alert strong {
        display: block;
        margin-bottom: 0.25rem;
    }
    
    .company-notes .alert div {
        margin-left: 0;
        padding-left: 0;
        border-left: none;
        margin-top: 0.25rem;
        padding: 0.25rem;
        background-color: rgba(233, 30, 99, 0.1);
        border-radius: 3px;
    }
    
    /* Stack table content vertically on very small screens */
    .company-block .table-responsive {
        border: none;
    }
    
    .company-block .table,
    .company-block .table thead,
    .company-block .table tbody,
    .company-block .table th,
    .company-block .table td,
    .company-block .table tr {
        display: block;
    }
    
    .company-block .table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    
    .company-block .table tr {
        border: 1px solid #ccc;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        background-color: white;
    }
    
    .company-block .table td {
        border: none;
        position: relative;
        padding-left: 50% !important;
        text-align: left;
        white-space: nowrap;
    }
    
    .company-block .table td:before {
        content: attr(data-label) ": ";
        position: absolute;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: bold;
        color: #495057;
    }
}

/* Color coding for franchise variants */
.franchise-variant-1 {
    color: #0f5132 !important;
    font-weight: 600;
}

.franchise-variant-2 {
    color: #052c65 !important;
    font-weight: 600;
}

/* Styles for company total rows */
.company-total-row {
    background-color: #fff3cd !important;
    border-top: 2px solid #ffc107 !important;
    font-weight: 600;
}

.company-total-row td {
    padding: 0.75rem 0.5rem !important;
    vertical-align: middle;
    border-top: 2px solid #ffc107 !important;
}

.company-total-row strong {
    font-size: 0.95rem;
    letter-spacing: 0.3px;
}

.company-total-row .bi-calculator {
    color: #1976d2;
    margin-right: 0.25rem;
}

/* Hover effect for total rows */
.company-total-row:hover {
    background-color: #ffeaa7 !important;
    transition: background-color 0.2s ease;
}

/* Mobile responsive styles for total rows */
@media (max-width: 576px) {
    .company-total-row td:before {
        font-weight: bold;
        color: #856404;
    }
    
    .company-total-row {
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        border-radius: 5px;
        margin-top: 10px;
    }
    
    /* Ensure franchise variant colors remain visible on mobile */
    .franchise-variant-1 {
        color: #0f5132 !important;
        font-weight: 600;
    }
    
    .franchise-variant-2 {
        color: #052c65 !important;
        font-weight: 600;
    }
}

/* Loading button styles */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: inherit;
}

/* Spinner animation for loading states */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.1em;
}

@keyframes spinner-border {
    to {
        transform: rotate(360deg);
    }
}

.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: -0.125em;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

/* Enhanced notification styles */
.alert.position-fixed {
    animation: slideInRight 0.3s ease-out;
    border-left: 4px solid;
}

.alert-success.position-fixed {
    border-left-color: #198754;
}

.alert-danger.position-fixed {
    border-left-color: #dc3545;
}

.alert-info.position-fixed {
    border-left-color: #0dcaf0;
}

.alert-warning.position-fixed {
    border-left-color: #ffc107;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Company response upload styles */
#company-response-form {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
}

#company-response-form:hover {
    border-color: #0d6efd;
    background-color: #f0f8ff;
}

#company-response-form.dragover {
    border-color: #198754;
    background-color: #f0fff4;
    transform: scale(1.02);
}

/* Multiple file upload styles */
#selected-files-list {
    margin-top: 1rem;
}

#files-container {
    max-height: 300px;
    overflow-y: auto;
}

.file-item {
    transition: all 0.2s ease;
}

.file-item:hover {
    background-color: #f8f9fa !important;
    border-color: #0d6efd !important;
}

.file-name {
    font-weight: 500;
    color: #495057;
}

.total-info {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 0.5rem;
}

/* Upload results styles */
#upload-results .alert {
    margin-bottom: 0.5rem;
}

#upload-results .alert:last-child {
    margin-bottom: 0;
}

#company-response-files {
    border: 2px solid #dee2e6;
    border-radius: 6px;
    padding: 0.75rem;
    transition: border-color 0.3s ease;
}

#company-response-file:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

#upload-progress .progress {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
}

#upload-progress .progress-bar {
    background: linear-gradient(45deg, #0d6efd, #198754);
}

#upload-results .alert {
    border-radius: 6px;
    border-left: 4px solid;
    animation: fadeInUp 0.3s ease-out;
}

#upload-results .alert-success {
    border-left-color: #198754;
    background-color: #d1e7dd;
}

#upload-results .alert-danger {
    border-left-color: #dc3545;
    background-color: #f8d7da;
}

#upload-results .alert ul {
    margin-bottom: 0;
    padding-left: 1.5rem;
}

#upload-results .alert li {
    margin-bottom: 0.25rem;
    color: inherit;
}

#upload-results .alert strong {
    font-weight: 600;
}

#upload-results .alert .bi {
    margin-right: 0.5rem;
    font-size: 1.1em;
}

/* Highlight problematic fields in error messages */
#upload-results .field-error {
    background-color: rgba(220, 53, 69, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: monospace;
    font-weight: 600;
}

#upload-results .success-detail {
    background-color: rgba(25, 135, 84, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-weight: 600;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive styles for upload form */
@media (max-width: 768px) {
    #company-response-form {
        padding: 1rem;
        margin: 0 -0.5rem;
    }
    
    #company-response-form .form-text {
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Функции для форматирования данных
function formatCurrency(amount) {
    if (!amount || isNaN(amount)) return '—';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatNumber(number) {
    if (!number || isNaN(number)) return '—';
    return new Intl.NumberFormat('ru-RU').format(number);
}

function formatPaymentsInfo(paymentsPerYear, premium) {
    if (!paymentsPerYear || paymentsPerYear <= 1) return '';
    
    const paymentText = paymentsPerYear === 2 ? 'платежа' : 
                       paymentsPerYear <= 4 ? 'платежа' : 'платежей';
    
    return `${paymentsPerYear} ${paymentText}/год`;
}

// Функция для обновления отображения данных в реальном времени
function updateOfferDisplay() {
    const offerRows = document.querySelectorAll('tbody tr');
    
    offerRows.forEach(row => {
        // Обновляем форматирование валютных полей
        const currencyFields = row.querySelectorAll('[data-currency]');
        currencyFields.forEach(field => {
            const amount = parseFloat(field.dataset.currency);
            if (!isNaN(amount)) {
                field.textContent = formatCurrency(amount);
            }
        });
        
        // Обновляем информацию о рассрочке
        const paymentsInfo = row.querySelector('.payments-info');
        if (paymentsInfo) {
            const paymentsPerYear = parseInt(paymentsInfo.dataset.payments);
            const premium = parseFloat(paymentsInfo.dataset.premium);
            
            if (paymentsPerYear > 1 && premium) {
                paymentsInfo.innerHTML = `<small class="text-muted">${formatPaymentsInfo(paymentsPerYear, premium)}</small>`;
            }
        }
    });
}

// Функция для добавления интерактивности к таблицам
function enhanceTableInteractivity() {
    const offerRows = document.querySelectorAll('tbody tr');
    
    offerRows.forEach(row => {
        // Добавляем hover эффект
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.style.transition = 'background-color 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
        
        // Row click functionality removed since notes are now displayed under company names
    });
}

// Функция для проверки совместимости браузера
function checkBrowserCompatibility() {
    const features = {
        fetch: typeof fetch !== 'undefined',
        intl: typeof Intl !== 'undefined',
        arrow: (() => { try { eval('() => {}'); return true; } catch(e) { return false; } })(),
        const: (() => { try { eval('const x = 1'); return true; } catch(e) { return false; } })()
    };
    
    const unsupported = Object.keys(features).filter(key => !features[key]);
    
    if (unsupported.length > 0) {
        console.warn('Некоторые функции могут не работать в вашем браузере:', unsupported);
        
        // Показываем предупреждение для старых браузеров
        if (unsupported.includes('fetch') || unsupported.includes('arrow')) {
            const warning = document.createElement('div');
            warning.className = 'alert alert-warning alert-dismissible fade show';
            warning.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Внимание!</strong> Ваш браузер устарел. Некоторые функции могут работать некорректно.
                Рекомендуем обновить браузер для лучшей работы.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid, .container, body').prepend(warning);
        }
    }
    
    return features;
}

// Утилиты для работы с сетью
function handleNetworkError(error) {
    console.error('Network error:', error);
    
    if (!navigator.onLine) {
        showErrorMessage('Отсутствует подключение к интернету. Проверьте соединение и попробуйте еще раз.');
        return;
    }
    
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
        showErrorMessage('Ошибка соединения с сервером. Попробуйте обновить страницу.');
        return;
    }
    
    showErrorMessage('Произошла сетевая ошибка. Попробуйте еще раз.');
}

// Проверка поддержки браузером необходимых функций для скачивания файлов
function checkDownloadSupport() {
    const features = {
        blob: typeof Blob !== 'undefined',
        url: typeof URL !== 'undefined' && typeof URL.createObjectURL === 'function',
        download: 'download' in document.createElement('a')
    };
    
    const unsupported = Object.keys(features).filter(key => !features[key]);
    
    if (unsupported.length > 0) {
        console.warn('Browser missing download features:', unsupported);
        showWarningMessage('Ваш браузер может не поддерживать автоматическое скачивание файлов. Попробуйте обновить браузер.', 8000);
        return false;
    }
    
    return true;
}

// Функция для безопасного создания и скачивания файла
function safeDownloadFile(blob, filename) {
    try {
        // Проверяем поддержку браузера
        if (!checkDownloadSupport()) {
            throw new Error('Браузер не поддерживает скачивание файлов');
        }
        
        // Создаем URL для blob
        const url = window.URL.createObjectURL(blob);
        
        // Создаем временную ссылку для скачивания
        const downloadLink = document.createElement('a');
        downloadLink.style.display = 'none';
        downloadLink.href = url;
        downloadLink.download = filename;
        
        // Добавляем обработчик для очистки ресурсов
        downloadLink.addEventListener('click', () => {
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                if (downloadLink.parentNode) {
                    downloadLink.parentNode.removeChild(downloadLink);
                }
            }, 100);
        });
        
        // Инициируем скачивание
        document.body.appendChild(downloadLink);
        downloadLink.click();
        
        return true;
    } catch (error) {
        console.error('Error in safeDownloadFile:', error);
        showErrorMessage('Ошибка при скачивании файла: ' + error.message);
        return false;
    }
}

// Функция для безопасного выполнения AJAX запросов
function safeAjaxRequest(url, options = {}) {
    const defaultOptions = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        credentials: 'same-origin',
    };
    
    const mergedOptions = { ...defaultOptions, ...options };
    
    // Добавляем CSRF токен если это POST запрос
    if (mergedOptions.method === 'POST' && !mergedOptions.body?.has?.('csrfmiddlewaretoken')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            if (mergedOptions.body instanceof FormData) {
                mergedOptions.body.append('csrfmiddlewaretoken', csrfToken);
            } else {
                mergedOptions.headers['X-CSRFToken'] = csrfToken;
            }
        }
    }
    
    return fetch(url, mergedOptions)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .catch(error => {
            handleNetworkError(error);
            throw error;
        });
}

// Функция для проверки состояния страницы
function checkPageState() {
    // Проверяем, не устарела ли страница
    const pageLoadTime = window.pageLoadTime || Date.now();
    const currentTime = Date.now();
    const pageAge = currentTime - pageLoadTime;
    
    // Если страница старше 30 минут, предлагаем обновить
    if (pageAge > 30 * 60 * 1000) {
        showWarningMessage('Страница устарела. Рекомендуем обновить для получения актуальных данных.', 10000);
    }
}

// Функции для показа уведомлений
function showNotification(message, type = 'info', duration = 3000) {
    // Удаляем существующие уведомления того же типа
    const existingAlerts = document.querySelectorAll(`.alert-${type}.position-fixed`);
    existingAlerts.forEach(alert => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    });
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);';
    
    const icons = {
        'success': 'bi-check-circle',
        'danger': 'bi-exclamation-triangle',
        'warning': 'bi-exclamation-triangle',
        'info': 'bi-info-circle'
    };
    
    const icon = icons[type] || icons['info'];
    
    alertDiv.innerHTML = `
        <i class="bi ${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Добавляем анимацию появления
    setTimeout(() => {
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
    
    // Автоматически удаляем через указанное время
    const timeoutId = setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.transition = 'all 0.3s ease-out';
            alertDiv.style.transform = 'translateX(100%)';
            alertDiv.style.opacity = '0';
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 300);
        }
    }, duration);
    
    // Позволяем пользователю закрыть уведомление вручную
    const closeButton = alertDiv.querySelector('.btn-close');
    if (closeButton) {
        closeButton.addEventListener('click', () => {
            clearTimeout(timeoutId);
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        });
    }
    
    return alertDiv;
}

function showSuccessMessage(message, duration = 3000) {
    return showNotification(message, 'success', duration);
}

function showErrorMessage(message, duration = 5000) {
    return showNotification(message, 'danger', duration);
}

function showWarningMessage(message, duration = 4000) {
    return showNotification(message, 'warning', duration);
}

function showInfoMessage(message, duration = 3000) {
    return showNotification(message, 'info', duration);
}

// Функция для показа индикатора загрузки
function showLoadingIndicator(message = 'Загрузка...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-indicator';
    loadingDiv.className = 'position-fixed d-flex align-items-center justify-content-center';
    loadingDiv.style.cssText = `
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
    `;
    
    loadingDiv.innerHTML = `
        <div class="bg-white p-4 rounded shadow text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <div>${message}</div>
        </div>
    `;
    
    document.body.appendChild(loadingDiv);
    return loadingDiv;
}

function hideLoadingIndicator() {
    const loadingDiv = document.getElementById('loading-indicator');
    if (loadingDiv && loadingDiv.parentNode) {
        loadingDiv.parentNode.removeChild(loadingDiv);
    }
}

// Company response upload functionality
function initializeCompanyResponseUpload() {
    const form = document.getElementById('company-response-form');
    const fileInput = document.getElementById('company-response-files');
    const progressDiv = document.getElementById('upload-progress');
    const resultsDiv = document.getElementById('upload-results');
    const selectedFilesList = document.getElementById('selected-files-list');
    const filesContainer = document.getElementById('files-container');
    
    if (!form) return; // Form only exists when status is 'collecting'
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const files = fileInput.files;
        if (!files || files.length === 0) {
            showUploadError('Пожалуйста, выберите файлы для загрузки');
            return;
        }
        
        // Validate files
        const validationResult = validateMultipleFiles(files);
        if (!validationResult.valid) {
            showUploadError(validationResult.error);
            return;
        }
        
        uploadMultipleCompanyResponses(files);
    });
    
    // Add drag and drop functionality
    form.addEventListener('dragover', function(e) {
        e.preventDefault();
        form.classList.add('dragover');
    });
    
    form.addEventListener('dragleave', function(e) {
        e.preventDefault();
        form.classList.remove('dragover');
    });
    
    form.addEventListener('drop', function(e) {
        e.preventDefault();
        form.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            // Trigger change event
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    });
    
    // File input change handler
    fileInput.addEventListener('change', function() {
        const files = this.files;
        if (files && files.length > 0) {
            // Clear previous results
            hideUploadResults();
            
            // Show selected files
            displaySelectedFiles(files);
        } else {
            // Hide file list if no files selected
            selectedFilesList.style.display = 'none';
        }
    });
}

function uploadMultipleCompanyResponses(files) {
    const form = document.getElementById('company-response-form');
    const submitButton = form.querySelector('button[type="submit"]');
    const progressDiv = document.getElementById('upload-progress');
    const resultsDiv = document.getElementById('upload-results');
    
    // Защита от повторной отправки
    if (submitButton.disabled) {
        console.log('Upload already in progress, ignoring duplicate request');
        return;
    }
    
    // Show progress indicator
    showUploadProgress();
    
    // Disable form
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Загрузка...';
    
    // Prepare form data
    const formData = new FormData();
    
    // Add all files to form data
    for (let i = 0; i < files.length; i++) {
        formData.append('excel_files', files[i]);
    }
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Get summary ID from URL or data attribute
    const summaryId = getSummaryId();
    
    // Upload files
    fetch(`/summaries/${summaryId}/upload-multiple-company-responses/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideUploadProgress();
        
        if (data.success) {
            showMultipleUploadSuccess(data);
            
            // Clear form
            form.reset();
            document.getElementById('selected-files-list').style.display = 'none';
            
            // Reload page after short delay to show new offers
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            showUploadError(data.error);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        hideUploadProgress();
        showUploadError('Произошла ошибка при загрузке файлов. Попробуйте еще раз.');
    })
    .finally(() => {
        // Re-enable form
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="bi bi-upload"></i> Загрузить предложения';
    });
}

function showUploadProgress() {
    const progressDiv = document.getElementById('upload-progress');
    if (progressDiv) {
        progressDiv.style.display = 'block';
    }
}

function hideUploadProgress() {
    const progressDiv = document.getElementById('upload-progress');
    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
}

function showUploadResults(content, type = 'info') {
    const resultsDiv = document.getElementById('upload-results');
    if (resultsDiv) {
        resultsDiv.innerHTML = content;
        resultsDiv.style.display = 'block';
    }
}

function hideUploadResults() {
    const resultsDiv = document.getElementById('upload-results');
    if (resultsDiv) {
        resultsDiv.style.display = 'none';
        resultsDiv.innerHTML = '';
    }
}

function getSummaryId() {
    // Extract summary ID from URL path
    const pathParts = window.location.pathname.split('/');
    for (let i = 0; i < pathParts.length; i++) {
        if (pathParts[i] === 'summaries' && i + 1 < pathParts.length) {
            const id = parseInt(pathParts[i + 1]);
            if (!isNaN(id)) {
                return id;
            }
        }
    }
    
    // Fallback: try to get from data attribute or other sources
    const summaryElement = document.querySelector('[data-summary-id]');
    if (summaryElement) {
        return parseInt(summaryElement.dataset.summaryId);
    }
    
    // Last resort: extract from current URL
    const match = window.location.pathname.match(/\/summaries\/(\d+)\//);
    return match ? parseInt(match[1]) : null;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showUploadError(message) {
    const content = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Ошибка загрузки:</strong><br>
            ${message}
        </div>
    `;
    showUploadResults(content, 'error');
    showErrorMessage(message, 5000);
}

function validateMultipleFiles(files) {
    // Constants from the backend
    const MAX_FILES = 10;
    const MAX_FILE_SIZE_MB = 1;
    const MAX_TOTAL_SIZE_MB = 10;
    
    if (!files || files.length === 0) {
        return {
            valid: false,
            error: 'Не выбрано ни одного файла для загрузки'
        };
    }
    
    // Check number of files
    if (files.length > MAX_FILES) {
        return {
            valid: false,
            error: `Слишком много файлов (${files.length}). Максимальное количество файлов: ${MAX_FILES}`
        };
    }
    
    let totalSize = 0;
    
    // Check each file
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Check file extension
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            return {
                valid: false,
                error: `Файл "${file.name}" имеет неподдерживаемый формат. Разрешены только файлы .xlsx`
            };
        }
        
        // Check file size
        const maxSizeBytes = MAX_FILE_SIZE_MB * 1024 * 1024;
        if (file.size > maxSizeBytes) {
            return {
                valid: false,
                error: `Файл "${file.name}" слишком большой (${formatFileSize(file.size)}). Максимальный размер: ${MAX_FILE_SIZE_MB}MB`
            };
        }
        
        // Check for empty files
        if (file.size === 0) {
            return {
                valid: false,
                error: `Файл "${file.name}" пуст`
            };
        }
        
        totalSize += file.size;
    }
    
    // Check total size
    const maxTotalSizeBytes = MAX_TOTAL_SIZE_MB * 1024 * 1024;
    if (totalSize > maxTotalSizeBytes) {
        return {
            valid: false,
            error: `Общий размер файлов слишком большой (${formatFileSize(totalSize)}). Максимальный общий размер: ${MAX_TOTAL_SIZE_MB}MB`
        };
    }
    
    return { valid: true };
}

function displaySelectedFiles(files) {
    const selectedFilesList = document.getElementById('selected-files-list');
    const filesContainer = document.getElementById('files-container');
    
    if (!selectedFilesList || !filesContainer) return;
    
    // Clear previous content
    filesContainer.innerHTML = '';
    
    let totalSize = 0;
    
    // Create file items
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        totalSize += file.size;
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded';
        
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <small class="text-muted">${formatFileSize(file.size)}</small>
            </div>
            <div class="file-status">
                <i class="bi bi-file-earmark-excel text-success"></i>
            </div>
        `;
        
        filesContainer.appendChild(fileItem);
    }
    
    // Add total info
    const totalInfo = document.createElement('div');
    totalInfo.className = 'total-info mt-2 p-2 text-center';
    totalInfo.innerHTML = `
        <small class="text-muted">
            <strong>Всего файлов:</strong> ${files.length} | 
            <strong>Общий размер:</strong> ${formatFileSize(totalSize)}
        </small>
    `;
    filesContainer.appendChild(totalInfo);
    
    // Show the list
    selectedFilesList.style.display = 'block';
}

function showUploadSuccess(message, details) {
    let content = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Успешно!</strong> ${message}
    `;
    
    if (details && details.length > 0) {
        content += '<ul class="mt-2 mb-0">';
        details.forEach(detail => {
            // Check if this is a company matching message
            if (detail.includes('Внимание:') || detail.includes('не найдено в списке')) {
                // Style warning messages differently
                content += `<li class="text-warning"><i class="bi bi-exclamation-triangle"></i> ${detail}</li>`;
            } else if (detail.includes('автоматически сопоставлено')) {
                // Style matching info messages
                content += `<li class="text-info"><i class="bi bi-info-circle"></i> ${detail}</li>`;
            } else {
                // Regular success details
                const formattedDetail = detail.replace(/(\d+\s*год[а-я]*)/gi, '<span class="success-detail">$1</span>');
                content += `<li>${formattedDetail}</li>`;
            }
        });
        content += '</ul>';
    }
    
    content += '</div>';
    showUploadResults(content, 'success');
    
    // Also show a toast notification
    showSuccessMessage('Предложение успешно загружено!', 3000);
}

function showUploadError(message, details) {
    let content = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Ошибка!</strong> ${message}
    `;
    
    if (details && details.length > 0) {
        content += '<ul class="mt-2 mb-0">';
        details.forEach(detail => {
            // Highlight field names and cell references in error messages
            let formattedDetail = detail
                .replace(/([A-Z]\d+)/g, '<span class="field-error">$1</span>') // Excel cell references
                .replace(/(франшиза|премия|страховая сумма|рассрочка|год|компания)/gi, '<span class="field-error">$1</span>'); // Field names
            
            content += `<li>${formattedDetail}</li>`;
        });
        content += '</ul>';
    }
    
    content += '</div>';
    showUploadResults(content, 'error');
    
    // Also show a toast notification
    showErrorMessage('Ошибка при загрузке файла', 5000);
}

function getSummaryId() {
    // Try to get from URL path
    const pathParts = window.location.pathname.split('/');
    const summaryIndex = pathParts.indexOf('summary');
    if (summaryIndex !== -1 && pathParts[summaryIndex + 1]) {
        return pathParts[summaryIndex + 1];
    }
    
    // Fallback: try to get from data attribute or other sources
    const summaryElement = document.querySelector('[data-summary-id]');
    if (summaryElement) {
        return summaryElement.dataset.summaryId;
    }
    
    // Last resort: extract from existing buttons/links
    const statusButton = document.querySelector('button[onclick*="changeStatus"]');
    if (statusButton) {
        const match = statusButton.getAttribute('onclick').match(/changeStatus\((\d+)\)/);
        if (match) {
            return match[1];
        }
    }
    
    throw new Error('Could not determine summary ID');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Validate multiple files on client side
function validateMultipleFiles(files) {
    const MAX_FILES = 10;
    const MAX_FILE_SIZE_MB = 1;
    const MAX_TOTAL_SIZE_MB = 10;
    
    // Check number of files
    if (files.length > MAX_FILES) {
        return {
            valid: false,
            error: `Слишком много файлов (${files.length}). Максимальное количество файлов: ${MAX_FILES}`
        };
    }
    
    let totalSize = 0;
    
    // Check each file
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Check file extension
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            return {
                valid: false,
                error: `Файл "${file.name}" имеет неподдерживаемый формат. Разрешены только файлы .xlsx`
            };
        }
        
        // Check file size
        const maxSizeBytes = MAX_FILE_SIZE_MB * 1024 * 1024;
        if (file.size > maxSizeBytes) {
            return {
                valid: false,
                error: `Файл "${file.name}" слишком большой (${formatFileSize(file.size)}). Максимальный размер: ${MAX_FILE_SIZE_MB}MB`
            };
        }
        
        // Check for empty files
        if (file.size === 0) {
            return {
                valid: false,
                error: `Файл "${file.name}" пуст`
            };
        }
        
        totalSize += file.size;
    }
    
    // Check total size
    const maxTotalSizeBytes = MAX_TOTAL_SIZE_MB * 1024 * 1024;
    if (totalSize > maxTotalSizeBytes) {
        return {
            valid: false,
            error: `Общий размер файлов слишком большой (${formatFileSize(totalSize)}). Максимальный общий размер: ${MAX_TOTAL_SIZE_MB}MB`
        };
    }
    
    return { valid: true };
}

// Display selected files with details
function displaySelectedFiles(files) {
    const selectedFilesList = document.getElementById('selected-files-list');
    const filesContainer = document.getElementById('files-container');
    
    if (!selectedFilesList || !filesContainer) return;
    
    // Clear previous content
    filesContainer.innerHTML = '';
    
    let totalSize = 0;
    
    // Create file items
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        totalSize += file.size;
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded';
        
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <small class="text-muted">${formatFileSize(file.size)}</small>
            </div>
            <div class="file-status">
                <i class="bi bi-file-earmark-excel text-success"></i>
            </div>
        `;
        
        filesContainer.appendChild(fileItem);
    }
    
    // Add total info
    const totalInfo = document.createElement('div');
    totalInfo.className = 'total-info mt-2 p-2 text-center';
    totalInfo.innerHTML = `
        <small class="text-muted">
            <strong>Всего файлов:</strong> ${files.length} | 
            <strong>Общий размер:</strong> ${formatFileSize(totalSize)}
        </small>
    `;
    filesContainer.appendChild(totalInfo);
    
    // Show the list
    selectedFilesList.style.display = 'block';
}

// Show multiple upload success results
function showMultipleUploadSuccess(data) {
    let content = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Загрузка завершена!</strong>
    `;
    
    if (data.total_files) {
        content += `<br>Обработано файлов: ${data.successful_files} из ${data.total_files}`;
        
        if (data.failed_files > 0) {
            content += ` (${data.failed_files} с ошибками)`;
        }
    }
    
    if (data.processing_time) {
        content += `<br><small class="text-muted">Время обработки: ${data.processing_time.toFixed(1)}с</small>`;
    }
    
    content += '</div>';
    
    // Show individual file results
    if (data.results && data.results.length > 0) {
        data.results.forEach(result => {
            if (result.success) {
                content += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        <strong>${result.file_name}</strong><br>
                        Компания: ${result.company_name}<br>
                        Создано предложений: ${result.offers_created}
                        ${result.years_processed ? `<br>Годы: ${result.years_processed.join(', ')}` : ''}
                    </div>
                `;
            } else {
                content += `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>${result.file_name}</strong><br>
                        Ошибка: ${result.error_message}
                    </div>
                `;
            }
        });
    }
    
    showUploadResults(content, 'success');
    
    // Show toast notification
    if (data.successful_files > 0) {
        showSuccessMessage(`Успешно загружено ${data.successful_files} файл(ов)!`, 4000);
    }
    
    if (data.failed_files > 0) {
        showWarningMessage(`${data.failed_files} файл(ов) содержали ошибки`, 4000);
    }
}


// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Сохраняем время загрузки страницы
    window.pageLoadTime = Date.now();
    
    checkBrowserCompatibility();
    updateOfferDisplay();
    enhanceTableInteractivity();
    initializeCompanyResponseUpload();
    
    // Устанавливаем текущий статус в селекте
    const statusSelect = document.getElementById('status-select');
    if (statusSelect) {
        const currentBadge = document.getElementById('current-status-badge');
        if (currentBadge) {
            // Извлекаем текущий статус из класса бейджа
            const badgeClasses = currentBadge.className;
            let currentStatus = 'collecting'; // по умолчанию
            
            if (badgeClasses.includes('bg-success')) {
                // Only 'completed_accepted' uses success color now
                currentStatus = 'completed_accepted';
            } else if (badgeClasses.includes('bg-danger')) {
                currentStatus = 'completed_rejected';
            } else if (badgeClasses.includes('bg-secondary')) {
                // Could be 'sent' or 'completed' - check text content
                const statusText = badge.textContent.trim();
                if (statusText.includes('Отправлен') || statusText.includes('Альянс')) {
                    currentStatus = 'sent';
                } else {
                    currentStatus = 'completed'; // fallback for old completed status
                }
            } else if (badgeClasses.includes('bg-info')) {
                currentStatus = 'ready';
            } else if (badgeClasses.includes('bg-warning')) {
                currentStatus = 'collecting';
            }
            
            statusSelect.dataset.currentStatus = currentStatus;
        }
    }
    
    // Обновляем отображение каждые 30 секунд (если страница активна)
    setInterval(() => {
        if (!document.hidden) {
            updateOfferDisplay();
            checkPageState();
        }
    }, 30000);
    
    // Обработчик для отслеживания изменений в сети
    window.addEventListener('online', () => {
        showSuccessMessage('Подключение к интернету восстановлено');
    });
    
    window.addEventListener('offline', () => {
        showWarningMessage('Отсутствует подключение к интернету');
    });
});

function sendToClient(summaryId) {
    if (confirm('Отправить свод в Альянс? Статус свода не изменится автоматически.')) {
        const button = event.target;
        const originalContent = button.innerHTML;
        
        // Показываем индикатор загрузки
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Отправка...';
        button.disabled = true;
        
        fetch(`/summaries/${summaryId}/send-to-client/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showSuccessMessage(data.message);
                // Не перезагружаем страницу, так как статус не изменился
            } else {
                showErrorMessage('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('Произошла ошибка при отправке свода');
        })
        .finally(() => {
            // Восстанавливаем кнопку
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
}

function deleteOffer(offerId) {
    // Получаем информацию о предложении из DOM
    const offerRow = event.target.closest('tr');
    const yearCell = offerRow.querySelector('td[data-label="Год"] strong');
    const companyBlock = offerRow.closest('.company-block');
    const companyTitle = companyBlock.querySelector('h5').textContent.trim().replace('🏢', '').trim(); // Извлекаем название компании, убираем иконку
    
    // Извлекаем год из текста (например, "1 год" -> "1")
    const yearText = yearCell ? yearCell.textContent.trim() : 'неизвестный год';
    
    // Создаем более информативное подтверждение
    const confirmMessage = `Вы действительно хотите удалить предложение от "${companyTitle}" (${yearText})?\n\nЭто действие нельзя отменить.`;
    
    if (confirm(confirmMessage)) {
        // Показываем индикатор загрузки
        const deleteButton = event.target.closest('button');
        const originalContent = deleteButton.innerHTML;
        deleteButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        deleteButton.disabled = true;
        
        // Добавляем визуальную обратную связь
        offerRow.style.opacity = '0.6';
        offerRow.style.pointerEvents = 'none';
        
        fetch(`/summaries/offer/${offerId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Показываем уведомление об успехе
                showSuccessMessage(data.message || 'Предложение успешно удалено');
                
                // Анимируем удаление строки
                offerRow.style.transition = 'all 0.5s ease-out';
                offerRow.style.opacity = '0';
                offerRow.style.transform = 'translateX(-100%)';
                
                // Перезагружаем страницу через небольшую задержку
                setTimeout(() => {
                    location.reload();
                }, 800);
            } else {
                // Восстанавливаем состояние строки
                offerRow.style.opacity = '';
                offerRow.style.pointerEvents = '';
                
                // Восстанавливаем кнопку
                deleteButton.innerHTML = originalContent;
                deleteButton.disabled = false;
                
                // Показываем ошибку
                showErrorMessage('Ошибка при удалении: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error deleting offer:', error);
            
            // Восстанавливаем состояние строки
            offerRow.style.opacity = '';
            offerRow.style.pointerEvents = '';
            
            // Восстанавливаем кнопку
            deleteButton.innerHTML = originalContent;
            deleteButton.disabled = false;
            
            showErrorMessage('Произошла ошибка при удалении предложения. Попробуйте еще раз.');
        });
    }
}

function generateSummaryFile(summaryId) {
    // Получаем кнопку и сохраняем исходное состояние
    const button = event.target;
    const originalContent = button.innerHTML;
    const originalDisabled = button.disabled;
    
    // Проверяем доступность функции
    if (!summaryId || isNaN(summaryId)) {
        showErrorMessage('Некорректный идентификатор свода');
        return;
    }
    
    // Проверяем подключение к интернету
    if (!navigator.onLine) {
        showErrorMessage('Отсутствует подключение к интернету. Проверьте соединение и попробуйте еще раз.');
        return;
    }
    
    // Показываем индикатор загрузки с анимацией
    button.innerHTML = '<i class="bi bi-hourglass-split spinner-border spinner-border-sm me-1"></i> Генерируется...';
    button.disabled = true;
    button.classList.add('btn-loading');
    
    // Показываем уведомление о начале процесса
    showInfoMessage('Начинается генерация Excel файла...', 2000);
    
    // Отправляем запрос на генерацию файла с улучшенной обработкой ошибок
    fetch(`/summaries/${summaryId}/generate-file/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Cache-Control': 'no-cache'
        }
    })
    .then(response => {
        // Проверяем статус ответа
        if (!response.ok) {
            // Если это JSON ошибка, парсим её
            if (response.headers.get('content-type')?.includes('application/json')) {
                return response.json().then(data => {
                    throw new Error(data.error || `Ошибка сервера: ${response.status}`);
                });
            } else {
                // Если это не JSON, создаем общую ошибку
                throw new Error(`Ошибка сервера: ${response.status} ${response.statusText}`);
            }
        }
        
        // Проверяем, что это действительно Excel файл
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('spreadsheet')) {
            throw new Error('Сервер вернул некорректный тип файла');
        }
        
        // Обрабатываем успешный ответ
        return response.blob().then(blob => {
            // Проверяем размер файла
            if (blob.size === 0) {
                throw new Error('Получен пустой файл');
            }
            
            // Получаем имя файла из заголовка Content-Disposition
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `svod_${summaryId}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                }
            }
            
            // Создаем и инициируем скачивание файла
            const downloadSuccess = safeDownloadFile(blob, filename);
            
            if (downloadSuccess) {
                // Показываем сообщение об успехе с дополнительной информацией
                showSuccessMessage(`Excel файл "${filename}" успешно сгенерирован и загружен`, 4000);
                
                // Логируем успешную операцию
                console.log(`Excel file generated successfully: ${filename}, size: ${blob.size} bytes`);
            } else {
                throw new Error('Ошибка при скачивании файла. Попробуйте еще раз.');
            }
        });
    })
    .catch(error => {
        console.error('Error generating summary file:', error);
        
        // Определяем тип ошибки и показываем соответствующее сообщение
        let errorMessage = 'Произошла ошибка при генерации файла';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage = 'Ошибка соединения с сервером. Проверьте подключение к интернету.';
        } else if (error.message.includes('Файл можно генерировать только для сводов в статусе')) {
            errorMessage = 'Файл можно генерировать только для сводов в статусе "Готов к отправке"';
        } else if (error.message.includes('недостающих данных')) {
            errorMessage = 'Невозможно сгенерировать файл: отсутствуют обязательные данные';
        } else if (error.message.includes('недоступности шаблона')) {
            errorMessage = 'Шаблон Excel файла недоступен. Обратитесь к администратору.';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        showErrorMessage(errorMessage, 6000);
        
        // Дополнительная информация для разработчиков в консоли
        console.error('Detailed error info:', {
            message: error.message,
            stack: error.stack,
            summaryId: summaryId,
            timestamp: new Date().toISOString()
        });
    })
    .finally(() => {
        // Восстанавливаем состояние кнопки
        button.innerHTML = originalContent;
        button.disabled = originalDisabled;
        button.classList.remove('btn-loading');
    });
}

// Функции управления статусом
function changeStatus(summaryId) {
    const statusSelect = document.getElementById('status-select');
    const newStatus = statusSelect.value;
    const currentBadge = document.getElementById('current-status-badge');
    
    if (!newStatus) {
        showErrorMessage('Выберите статус');
        return;
    }
    
    // Получаем текущий статус для сравнения
    const currentStatus = statusSelect.dataset.currentStatus || statusSelect.querySelector('option[selected]')?.value;
    
    if (newStatus === currentStatus) {
        showInfoMessage('Статус уже установлен');
        return;
    }
    
    // Показываем индикатор загрузки
    const applyButton = event.target;
    const originalContent = applyButton.innerHTML;
    applyButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Применяется...';
    applyButton.disabled = true;
    statusSelect.disabled = true;
    
    // Создаем FormData для отправки
    const formData = new FormData();
    formData.append('status', newStatus);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/summaries/${summaryId}/change-status/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Обновляем бейдж статуса
            updateStatusBadge(data.new_status, data.new_status_display);
            // Обновляем селект
            statusSelect.value = data.new_status;
            statusSelect.dataset.currentStatus = data.new_status;
            
            showSuccessMessage(data.message);
            
            // Перезагружаем страницу через 1.5 секунды для обновления интерфейса
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showErrorMessage('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error changing status:', error);
        showErrorMessage('Произошла ошибка при изменении статуса. Попробуйте еще раз.');
    })
    .finally(() => {
        // Восстанавливаем элементы управления
        applyButton.innerHTML = originalContent;
        applyButton.disabled = false;
        statusSelect.disabled = false;
    });
}

// Быстрое изменение статуса
function quickStatusChange(summaryId, newStatus) {
    const confirmMessages = {
        'ready': 'Отметить свод как готовый к отправке?',
        'sent': 'Отметить свод как отправленный в Альянс?',
        'completed_accepted': 'Отметить свод как завершенный (акцепт/распоряжение)?',
        'completed_rejected': 'Отметить свод как завершенный (не будет)?'
    };
    
    const message = confirmMessages[newStatus] || 'Изменить статус?';
    
    if (confirm(message)) {
        // Показываем индикатор загрузки
        const button = event.target;
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Применяется...';
        button.disabled = true;
        
        // Создаем FormData для отправки
        const formData = new FormData();
        formData.append('status', newStatus);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/summaries/${summaryId}/change-status/`, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Обновляем бейдж статуса
                updateStatusBadge(data.new_status, data.new_status_display);
                // Обновляем селект
                document.getElementById('status-select').value = data.new_status;
                showSuccessMessage(data.message);
                
                // Перезагружаем страницу через 1 секунду для обновления интерфейса
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showErrorMessage('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('Произошла ошибка при изменении статуса');
        })
        .finally(() => {
            // Восстанавливаем кнопку
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
}

function updateStatusBadge(status, statusDisplay) {
    const badge = document.getElementById('current-status-badge');
    if (badge) {
        // Удаляем все классы цветов и текста
        badge.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-secondary', 'bg-danger', 'text-dark');
        
        // Добавляем соответствующий класс цвета и текста
        switch(status) {
            case 'completed_accepted':
                badge.classList.add('bg-success');
                break;
            case 'completed_rejected':
                badge.classList.add('bg-danger');
                break;
            case 'sent':
                badge.classList.add('bg-secondary');
                break;
            case 'ready':
                badge.classList.add('bg-info', 'text-dark');
                break;
            case 'collecting':
                badge.classList.add('bg-warning', 'text-dark');
                break;
            default:
                badge.classList.add('bg-secondary');
        }
        
        // Обновляем текст
        badge.textContent = statusDisplay;
    }
}

// Дублирующаяся функция удалена - используется версия выше

function showWarningMessage(message, duration = 3000) {
    showMessage(message, 'warning', duration);
}

function showMessage(message, type = 'info', duration = 3000) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        max-width: 500px;
    `;
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after duration
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, duration);
}

function showErrorMessage(message, duration = 3000) {
    showMessage(message, 'danger', duration);
}

function showSuccessMessage(message, duration = 3000) {
    showMessage(message, 'success', duration);
}

// Инициализация при загрузке страницы
// Дублирующийся вызов удален - функция уже вызывается выше в строке 1827
</script>
{% endblock %}