# Changelog: Функциональность выбора страховой компании

## Версия 1.1 (06.12.2025)

### Исправления
- **Исправлена обработка многолетних предложений**: Теперь компания, представившая предложения на несколько лет (многолетний договор), отображается в списке выбора только один раз
- Обновлен метод `get_unique_companies_list()` для гарантированной уникальности названий компаний с использованием `set()`
- Добавлен автоматический тест для проверки корректной обработки многолетних предложений

### Технические детали
- Изменен метод `InsuranceSummary.get_unique_companies_list()`:
  - Старая реализация: `list(self.offers.filter(is_valid=True).values_list('company_name', flat=True).distinct())`
  - Новая реализация: `sorted(list(set(self.offers.filter(is_valid=True).values_list('company_name', flat=True))))`
- Добавлен тест `test_multiyear_company_appears_once` для проверки уникальности компаний в списке

### Пример
**До исправления:**
- Компания "Абсолют" с предложениями на 2 года могла отображаться в списке дважды

**После исправления:**
- Компания "Абсолют" с предложениями на 2 года отображается в списке только один раз
- Выбирая "Абсолют", пользователь выбирает все годы многолетнего предложения

---

## Версия 1.0 (06.12.2025)

### Новая функциональность
- Добавлена обязательность выбора страховой компании при переводе свода в статус "Завершен: акцепт/распоряжение"
- Добавлено поле `selected_company` в модель `InsuranceSummary`
- Реализована валидация на уровне формы и представления
- Добавлен динамический UI для выбора компании в шаблоне
- Создана миграция базы данных `0014_add_selected_company_field`
- Написаны автоматические тесты
- Создана документация для пользователей и разработчиков

### Файлы изменены
- `summaries/models.py` - добавлено поле и методы
- `summaries/forms.py` - обновлена форма с валидацией
- `summaries/views.py` - добавлена логика проверки
- `summaries/templates/summaries/summary_detail.html` - добавлен UI
- `summaries/templates/summaries/summary_list.html` - добавлено отображение
- `summaries/migrations/0014_add_selected_company_field.py` - миграция БД
- `summaries/test_selected_company.py` - тесты
- `docs/selected_company_feature.md` - техническая документация
- `docs/user_guide_selected_company.md` - руководство пользователя
