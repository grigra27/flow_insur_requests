# Обработка Excel файлов заявок

## Обзор

Система обрабатывает Excel файлы заявок (.xls и .xlsx) и извлекает из них данные согласно следующим правилам:

## Правила извлечения данных

### 1. Тип страхования
- **Ячейка D21**: Если содержит значение → `КАСКО`
- **Ячейка D22**: Если содержит значение → `страхование спецтехники`
- **По умолчанию**: `КАСКО` (если обе ячейки пустые)
- **Приоритет**: D21 имеет приоритет над D22

### 2. Срок страхования
- **Ячейки M15 и N15**: Дата начала и дата окончания
- **Формат**: `с {дата_начала} по {дата_окончания}`
- **Пример**: `с 20.08.2025 по 20.08.2028`

### 3. Номер ДФА
- **Ячейки HIJ2**: Номер договора финансовой аренды
- **Логика**: Система ищет непустые значения в ячейках H2, I2, J2 и объединяет их
- **Пример**: "ТС-20212-ГА-КЗ"

### 4. Филиал
- **Ячейки CDEF4**: Название филиала
- **Логика**: Система ищет непустые значения в ячейках C4, D4, E4, F4 и объединяет их
- **Пример**: "Казанский филиал"

### 5. Название клиента
- **Ячейка D7**: Название клиента (может быть объединенной ячейкой D-F, строка 7)

### 6. ИНН клиента
- **Ячейка D9**: ИНН (может быть объединенной ячейкой D-F, строка 9)

### 7. Информация о предмете лизинга
- **Ячейки**: Поиск в CDEFGHI43, CDEFGHI45, CDEFGHI47, CDEFGHI49
- **Логика**: Система ищет непустые значения во всех указанных ячейках и объединяет их
- **Пример**: "специальный, грузовой бортовой оснащенный краном-манипулятором СПМ Авто 732457"

### 8. Срок ответа
- **Правило**: Текущее время + 3 часа
- **Формат**: DateTime с учетом часового пояса

### 9. Франшиза
- **Ячейка D29**: 
  - Есть значение → франшиза **ЕСТЬ** (`True`)
  - Пустая → франшиза **НЕТ** (`False`)

### 10. Рассрочка
- **Ячейка F34**:
  - Есть значение → рассрочки **НЕТ** (`False`)
  - Пустая → рассрочка **ЕСТЬ** (`True`)

### 11. Автозапуск
- **Ячейка M24** (может быть объединена с N24):
  - `"нет"` → автозапуска **НЕТ** (`False`)
  - Любое другое значение → автозапуск **ЕСТЬ** (`True`)
  - Пустая → автозапуска **НЕТ** (`False`)

## Технические детали

### Поддерживаемые форматы
- `.xls` - обрабатывается через pandas + xlrd
- `.xlsx` - обрабатывается через openpyxl

### Обработка ошибок
- При ошибке чтения файла возвращаются данные по умолчанию
- Все операции логируются
- Неправильные форматы дат обрабатываются gracefully

### Пример использования

```python
from core.excel_utils import ExcelReader

reader = ExcelReader('request1.xls')
data = reader.read_insurance_request()

print(data)
# {
#   'client_name': 'ООО "АЛТЫН ЯР"',
#   'inn': '1686035567',
#   'insurance_type': 'КАСКО',
#   'insurance_period': 'с 20.08.2025 по 20.08.2028',
#   'vehicle_info': 'специальный, грузовой бортовой оснащенный краном-манипулятором СПМ Авто 732457',
#   'dfa_number': 'ТС-20212-ГА-КЗ',
#   'branch': 'Казанский филиал',
#   'has_franchise': True,
#   'has_installment': False,
#   'has_autostart': False,
#   'response_deadline': datetime(2025, 9, 2, 15, 25, 6)
# }
```

## Генерация темы письма

Система автоматически генерирует тему письма по шаблону:
**"ДФА - Филиал - Информация о предмете лизинга - порядковый номер письма"**

### Пример генерации темы:

```python
from core.templates import EmailTemplateGenerator

template_generator = EmailTemplateGenerator()
subject = template_generator.generate_subject(data, sequence_number=1)

print(subject)
# "ТС-20212-ГА-КЗ - Казанский филиал - специальный, грузовой бортовой оснащенный крано... - 1"
```

### Особенности:
- Информация о предмете лизинга обрезается до 50 символов для удобочитаемости
- Порядковый номер письма можно указать при генерации (по умолчанию 1)
- Все компоненты темы извлекаются из соответствующих ячеек Excel файла

## Тестирование

Для тестирования логики обработки используйте:

```bash
# Тест с реальным файлом
python test_excel_upload.py

# Тест различных сценариев
python test_excel_scenarios.py
```

## Интеграция с Django

Обработанные данные автоматически сохраняются в модель `InsuranceRequest`:
- Все извлеченные данные сохраняются в соответствующие поля модели
- Дополнительные данные сохраняются в JSON поле `additional_data`
- Создается вложение `RequestAttachment` с оригинальным файлом